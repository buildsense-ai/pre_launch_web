<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>buildsense - AI å¯¹è¯åŠ©æ‰‹ Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* ä¸»é¢˜å˜é‡ */
        :root {
            --primary-color: #8b5cf6;
            --primary-hover: #7c3aed;
            --secondary-color: #a78bfa;
            --accent-color: #06b6d4;
            --success-color: #10b981;
            
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #f5f5f5;
            --bg-hover: #f0f0f0;
            --bg-active: #ede9fe;
            
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-tertiary: #999999;
            --text-inverse: #ffffff;
            
            --border-color: #e0e0e0;
            --border-light: #f0f0f0;
            
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.1);
            
            --gradient-primary: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
            position: relative;
        }

        /* ========== å·¦ä¾§è¾¹æ  ========== */
        .sidebar {
            width: 280px;
            background: var(--bg-primary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }

        .logo {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 16px;
        }

        .settings-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--bg-secondary);
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 18px;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .settings-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .chat-actions {
            display: flex;
            gap: 8px;
        }

        .new-chat-btn {
            flex: 1;
            padding: 12px 16px;
            background: var(--gradient-primary);
            color: var(--text-inverse);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .new-chat-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .back-btn {
            background: white !important;
            color: var(--text-secondary) !important;
            border: 1px solid var(--border-color) !important;
        }

        .back-btn:hover {
            background: var(--bg-hover) !important;
        }

        /* æ ‡ç­¾é¡µ */
        .sidebar-tabs {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-tab {
            flex: 1;
            padding: 12px 16px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 14px;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            position: relative;
        }

        .sidebar-tab:hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }

        .sidebar-tab.active {
            color: var(--text-primary);
            background: var(--bg-primary);
            font-weight: 500;
        }

        .sidebar-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary-color);
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .tab-content.active {
            display: block;
        }

        /* æ–‡ä»¶åˆ—è¡¨ */
        .files-section {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .files-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            cursor: pointer;
        }

        .files-section-title {
            font-weight: 500;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .caret {
            font-size: 12px;
            transition: transform 0.2s;
        }

        .files-section.collapsed .caret {
            transform: rotate(-90deg);
        }

        .files-count {
            background: var(--bg-primary);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .files-section-content {
            display: block;
        }

        .files-section.collapsed .files-section-content {
            display: none;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-primary);
            transition: background 0.2s;
        }

        .file-item:hover {
            background: var(--bg-hover);
        }

        .file-item.active {
            background: var(--bg-active);
            color: var(--primary-color);
            font-weight: 500;
        }

        .file-icon {
            font-size: 16px;
        }

        /* å¯¹è¯å†å² */
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .history-item {
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .history-item:hover {
            background: var(--bg-hover);
            transform: translateX(2px);
        }

        .history-title {
            font-size: 13px;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .history-time {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        /* ========== ä¸­é—´èŠå¤©åŒº ========== */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            overflow: hidden;
        }

        .chat-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-title-section {
            text-align: center;
            flex: 1;
        }

        .chat-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .project-info {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .welcome-prompts {
            text-align: center;
            padding: 40px 20px;
        }

        .welcome-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .welcome-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* æ¶ˆæ¯æ ·å¼ */
        .chat-messages {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .message {
            display: flex;
            gap: 12px;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            color: white;
        }

        .message.user .message-avatar {
            background: var(--primary-color);
        }

        .message.ai .message-avatar {
            background: var(--success-color);
        }

        .message-content {
            flex: 1;
        }

        .message-text {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .task-info {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .task-info-item {
            margin: 4px 0;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            background: var(--success-color);
            color: white;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
        }

        .file-links {
            margin-top: 12px;
        }

        .file-links-title {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 13px;
            color: var(--text-primary);
        }

        .file-link-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
        }

        .file-link {
            color: var(--primary-color);
            text-decoration: none;
            font-size: 13px;
        }

        .file-link:hover {
            text-decoration: underline;
        }

        .file-link-button {
            padding: 6px 12px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-link-button:hover {
            background: var(--primary-hover);
        }

        /* è¾“å…¥åŒºåŸŸ */
        .input-area {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-primary);
            transition: all 0.3s ease;
        }

        /* Agent çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .input-area.plan-agent-mode {
            border-top: 2px solid var(--primary-color);
            background: linear-gradient(to bottom, #faf5ff 0%, var(--bg-primary) 100%);
        }

        .agent-status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            font-size: 13px;
            transition: all 0.3s ease;
        }

        .agent-status-indicator.hidden {
            display: none;
        }

        .agent-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: var(--primary-color);
            color: white;
            border-radius: 12px;
            font-weight: 600;
            font-size: 12px;
        }

        .agent-badge.main-agent {
            background: var(--success-color);
        }

        .agent-badge.plan-agent {
            background: var(--primary-color);
        }

        .agent-status-text {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .input-container {
            position: relative;
        }

        .deep-research-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .deep-research-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .apple-toggle {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .apple-toggle-input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .apple-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color);
            transition: 0.3s;
            border-radius: 24px;
        }

        .apple-toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .apple-toggle-input:checked + .apple-toggle-slider {
            background-color: var(--primary-color);
        }

        .apple-toggle-input:checked + .apple-toggle-slider:before {
            transform: translateX(20px);
        }

        .input-field {
            width: 100%;
            padding: 12px 120px 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            transition: border-color 0.2s;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .input-actions {
            position: absolute;
            right: 8px;
            bottom: 8px;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .attach-btn, .send-button {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .attach-btn {
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .attach-btn:hover {
            background: var(--bg-hover);
        }

        .send-button {
            background: var(--primary-color);
            color: white;
        }

        .send-button:hover {
            background: var(--primary-hover);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .model-selector {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 13px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
        }

        /* ========== å³ä¾§æ–‡æ¡£é¢„è§ˆ ========== */
        .preview-sidebar {
            width: 0;
            background: var(--bg-primary);
            border-left: 1px solid var(--border-color);
            overflow: hidden;
            transition: width 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .preview-sidebar.open {
            width: 600px;
        }

        .preview-sidebar-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .preview-sidebar-title {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .preview-sidebar-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px 8px;
            line-height: 1;
        }

        .preview-sidebar-close:hover {
            color: var(--text-primary);
        }

        .preview-toolbar {
            padding: 12px 24px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .toolbar-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .preview-btn {
            padding: 6px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 13px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .preview-btn:hover {
            background: var(--bg-hover);
            transform: translateY(-1px);
        }

        .preview-content {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
        }

        .preview-content h2 {
            font-size: 24px;
            margin: 24px 0 16px;
            color: var(--text-primary);
        }

        .preview-content h3 {
            font-size: 18px;
            margin: 20px 0 12px;
            color: var(--text-primary);
        }

        .preview-content p {
            font-size: 14px;
            line-height: 1.8;
            color: var(--text-primary);
            margin: 12px 0;
        }

        /* æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-tertiary);
        }

        /* ========== æ–‡ä»¶å¤„ç†é€‰æ‹©æ¨¡æ€æ¡† ========== */
        .file-processing-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .file-processing-modal.show {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #92400e;
            text-align: center;
            margin-bottom: 24px;
        }

        .selected-file-info {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 24px;
            text-align: center;
        }

        .selected-file-name {
            font-size: 14px;
            color: #78350f;
            word-break: break-all;
        }

        .selected-file-size {
            font-size: 12px;
            color: #92400e;
            margin-top: 4px;
        }

        .modal-subtitle {
            font-size: 16px;
            color: #92400e;
            text-align: center;
            margin-bottom: 20px;
        }

        .processing-options {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
        }

        .processing-option {
            flex: 1;
            padding: 20px;
            background: white;
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .processing-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
        }

        .processing-option.pdf-parse {
            border-color: #8b5cf6;
        }

        .processing-option.pdf-parse:hover {
            background: #f5f3ff;
        }

        .processing-option.template-extract {
            border-color: #10b981;
        }

        .processing-option.template-extract:hover {
            background: #ecfdf5;
        }

        .option-label {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .option-desc {
            font-size: 13px;
            color: #6b7280;
        }

        .modal-close-btn {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.1);
            border: none;
            border-radius: 8px;
            color: #78350f;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-close-btn:hover {
            background: rgba(0, 0, 0, 0.15);
        }

        /* ========== æ–‡ä»¶ä¸Šä¼ è¿›åº¦æ˜¾ç¤º ========== */
        .upload-progress-message {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-top: 12px;
        }

        .progress-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .progress-icon {
            font-size: 20px;
            animation: rotate 1s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .progress-file-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .progress-bar-container {
            background: var(--bg-tertiary);
            border-radius: 8px;
            height: 8px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--gradient-primary);
            transition: width 0.3s ease;
            border-radius: 8px;
        }

        .progress-status {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .upload-complete-message {
            background: #ecfdf5;
            border: 1px solid #10b981;
            border-radius: 12px;
            padding: 16px;
            margin-top: 12px;
        }

        .complete-header {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .complete-icon {
            font-size: 20px;
        }

        .complete-text {
            font-size: 14px;
            font-weight: 500;
            color: #059669;
        }

        .complete-file-name {
            font-size: 13px;
            color: #047857;
            margin-top: 4px;
        }

        /* ========== æ€è€ƒè¿‡ç¨‹æ ·å¼ ========== */
        .thinking-container {
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
            border: 1px solid #e9d5ff;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 12px;
            font-family: 'Courier New', monospace;
        }

        .thinking-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
        }

        .thinking-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #7c3aed;
            font-weight: 500;
        }

        .thinking-icon {
            font-size: 16px;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .thinking-toggle {
            font-size: 12px;
            color: #a78bfa;
            transition: transform 0.2s;
        }

        .thinking-container.collapsed .thinking-toggle {
            transform: rotate(-90deg);
        }

        .thinking-content {
            margin-top: 12px;
            font-size: 13px;
            color: #6b21a8;
            line-height: 1.6;
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
        }

        .thinking-container.collapsed .thinking-content {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
        }

        .thinking-step {
            margin: 12px 0;
            padding: 8px 0;
            border-top: 1px dashed #e9d5ff;
        }

        .thinking-step:first-child {
            border-top: none;
        }

        /* æ‰“å­—å…‰æ ‡æ•ˆæœ */
        .typing-cursor {
            display: inline-block;
            width: 2px;
            height: 1em;
            background: var(--primary-color);
            margin-left: 2px;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* AIå“åº”æ ·å¼ä¼˜åŒ– */
        .ai-response-text {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-primary);
        }

        /* ========== æ¨¡æ¿æ¨èå¡ç‰‡ ========== */
        .template-recommendations {
            margin-top: 16px;
        }

        .template-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .template-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.15);
        }

        .template-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .template-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .template-match {
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            background: #ecfdf5;
            color: #059669;
            border-radius: 12px;
        }

        .template-meta {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-bottom: 12px;
        }

        .template-actions {
            display: flex;
            gap: 8px;
        }

        .template-btn {
            flex: 1;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .template-btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .template-btn-primary:hover {
            background: var(--primary-hover);
        }

        .template-btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .template-btn-secondary:hover {
            background: var(--bg-hover);
        }

        .template-structure {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-light);
            font-size: 12px;
            line-height: 2;
            color: var(--text-secondary);
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .template-card.expanded .template-structure {
            max-height: 500px;
        }

        .template-structure-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        /* ========== ç”Ÿæˆè®¡åˆ’é¢æ¿ ========== */
        .generation-plan-panel {
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            width: 0;
            background: var(--bg-primary);
            border-left: 1px solid var(--border-color);
            overflow: hidden;
            transition: width 0.3s ease;
            display: flex;
            flex-direction: column;
            z-index: 999;
        }

        .generation-plan-panel.open {
            width: 400px;
        }

        .plan-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-primary);
        }

        .plan-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .plan-close {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px 8px;
            line-height: 1;
        }

        .plan-close:hover {
            color: var(--text-primary);
        }

        .plan-progress {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-light);
            background: var(--bg-secondary);
        }

        .plan-progress-text {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .plan-progress-bar {
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
        }

        .plan-progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            transition: width 0.3s ease;
        }

        .plan-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px 20px;
        }

        .plan-item {
            padding: 14px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 3px solid transparent;
            transition: all 0.2s;
        }

        .plan-item.completed {
            border-left-color: #10b981;
            background: #f0fdf4;
        }

        .plan-item.generating {
            border-left-color: var(--primary-color);
            background: #faf5ff;
        }

        .plan-item.pending {
            border-left-color: #d1d5db;
        }

        .plan-item-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .plan-item-status {
            font-size: 16px;
        }

        .plan-item-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
        }

        .plan-item-badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 500;
        }

        .badge-core {
            background: #fef3c7;
            color: #92400e;
        }

        .plan-item-desc {
            font-size: 12px;
            line-height: 1.6;
            color: var(--text-secondary);
            padding-left: 24px;
        }

        /* è®¡åˆ’ç¡®è®¤æŒ‰é’® */
        .plan-confirmation {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-secondary);
            display: flex;
            gap: 12px;
        }

        .plan-confirmation.hidden {
            display: none;
        }

        .plan-confirm-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .plan-confirm-btn.primary {
            background: var(--primary-color);
            color: white;
        }

        .plan-confirm-btn.primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .plan-confirm-btn.secondary {
            background: white;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .plan-confirm-btn.secondary:hover {
            background: var(--bg-hover);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§è¾¹æ  -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">buildsense</div>
                <button class="settings-btn" onclick="alert('è®¾ç½®åŠŸèƒ½')">âš™ï¸</button>
                <div class="chat-actions">
                    <button class="new-chat-btn back-btn" onclick="alert('è¿”å›é¡¹ç›®é€‰æ‹©')">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <span>è¿”å›</span>
                    </button>
                    <button class="new-chat-btn" onclick="startNewChat()">
                        <span>æ–°å»ºå¯¹è¯</span>
                    </button>
                </div>
            </div>

            <div class="sidebar-tabs">
                <button class="sidebar-tab active" onclick="switchTab('files')">
                    ğŸ“ æ–‡ä»¶
                </button>
                <button class="sidebar-tab" onclick="switchTab('history')">
                    ğŸ• å¯¹è¯è®°å½•
                </button>
            </div>

            <div class="tab-content active" id="filesTab">
                <div class="files-section" id="filesSection">
                    <div class="files-section-header" onclick="toggleFilesSection()">
                        <div class="files-section-title">
                            <span class="caret">â–¼</span>
                            <span>é¡¹ç›®æ–‡ä»¶</span>
                        </div>
                        <span class="files-count">5</span>
                    </div>
                    <div class="files-section-content">
                        <div class="file-item active">
                            <span class="file-icon">ğŸ“•</span>
                            <span>åŒå›¾é©±åŠ¨çš„è”æƒ³å¼è®°å¿†å¢é‡æ›´æ–°ç®—æ³•ç ”ç©¶å¼€é¢˜æ„æƒ³.pdf</span>
                        </div>
                        <div class="file-item">
                            <span class="file-icon">ğŸ“</span>
                            <span>ç›¸å…³æ–‡çŒ®ç»¼è¿°_20241115.md</span>
                        </div>
                        <div class="file-item">
                            <span class="file-icon">ğŸ“</span>
                            <span>å›¾ç»“æ„è®¾è®¡æ–¹æ¡ˆ_20241118.md</span>
                        </div>
                        <div class="file-item">
                            <span class="file-icon">ğŸ“Š</span>
                            <span>å®éªŒæ•°æ®åˆ†æ_20241120.xlsx</span>
                        </div>
                        <div class="file-item">
                            <span class="file-icon">ğŸ“</span>
                            <span>ç®—æ³•ä¼˜åŒ–è®°å½•_20241122.md</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="historyTab">
                <div class="history-list">
                    <div class="history-item" onclick="loadHistoryChat('å›¾ç»“æ„è®¾è®¡è®¨è®º')">
                        <div class="history-title">å›¾ç»“æ„è®¾è®¡è®¨è®º</div>
                        <div class="history-time">2å°æ—¶å‰</div>
                    </div>
                    <div class="history-item" onclick="loadHistoryChat('æ–‡çŒ®ç»¼è¿°æ•´ç†')">
                        <div class="history-title">æ–‡çŒ®ç»¼è¿°æ•´ç†</div>
                        <div class="history-time">æ˜¨å¤©</div>
                    </div>
                    <div class="history-item" onclick="loadHistoryChat('å®éªŒæ–¹æ¡ˆè®¾è®¡')">
                        <div class="history-title">å®éªŒæ–¹æ¡ˆè®¾è®¡</div>
                        <div class="history-time">3å¤©å‰</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸­é—´èŠå¤©åŒº -->
        <div class="main-content">
            <div class="chat-header">
                <div></div>
                <div class="chat-title-section">
                    <div class="chat-title">AI å¯¹è¯åŠ©æ‰‹</div>
                    <div class="project-info">
                        <span>ğŸ§ </span>
                        <span>å›¾é©±åŠ¨è®°å¿†ç®¡ç†ç ”ç©¶</span>
                    </div>
                </div>
                <div></div>
            </div>

            <div class="chat-container" id="chatContainer">
                <div class="welcome-prompts" id="welcomePrompts">
                    <div class="welcome-title">ğŸ§  å›¾é©±åŠ¨è®°å¿†ç®¡ç†ç ”ç©¶åŠ©æ‰‹</div>
                    <div class="welcome-subtitle">ç‚¹å‡»å·¦ä¾§"æ–°å»ºå¯¹è¯"å¼€å§‹ç ”ç©¶è®¨è®ºï¼Œæˆ–ç‚¹å‡»æ–‡ä»¶æŸ¥çœ‹æ–‡æ¡£</div>
                </div>

                <div class="chat-messages" id="chatMessages" style="display: none;">
                    <!-- å¯¹è¯æ¶ˆæ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
                </div>
            </div>

            <div class="input-area" id="inputArea">
                <!-- Agent çŠ¶æ€æŒ‡ç¤ºå™¨ -->
                <div class="agent-status-indicator hidden" id="agentStatusIndicator">
                    <span class="agent-badge main-agent" id="agentBadge">
                        <span>ğŸ¤–</span>
                        <span id="agentName">Main Agent</span>
                    </span>
                    <span class="agent-status-text" id="agentStatusText">æ­£åœ¨å¤„ç†æ‚¨çš„è¯·æ±‚...</span>
                </div>

                <div class="input-container">
                    <div class="deep-research-container">
                        <label class="deep-research-label">
                            <span class="deep-research-text">Deep Research</span>
                            <div class="apple-toggle">
                                <input type="checkbox" id="deepResearchToggle" class="apple-toggle-input">
                                <span class="apple-toggle-slider"></span>
                            </div>
                        </label>
                        <span style="font-size: 12px; color: var(--text-tertiary);">è€ƒè™‘å—ï¼Ÿæ‰¾æˆ‘å°±å¯¹äº†ï¼</span>
                    </div>
                    
                    <textarea class="input-field" id="inputField" 
                              placeholder="å¸®æˆ‘ç”Ÿæˆè¿™ä¸ªæ™ºèƒ½é•¿æ¡£æ¡ˆä¸AIå·¥å…·çš„"å•†ä¸šè®¡åˆ’ä¹¦"å§ã€‚åŒ…æ‹¬why, how, what, whenç­‰" 
                              rows="1"></textarea>
                    
                    <div class="input-actions">
                        <input type="file" id="fileInput" accept=".pdf,.doc,.docx,.txt" style="display: none;">
                        <button class="attach-btn" id="attachBtn" title="ä¸Šä¼ æ–‡ä»¶" onclick="document.getElementById('fileInput').click()">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                <path d="M8 1V15M1 8H15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </button>
                        <select class="model-selector" id="modelSelector">
                            <option value="deepseek">DeepSeek</option>
                            <option value="qwen">Qwen</option>
                        </select>
                        <button class="send-button" id="sendButton">
                            <span>â–¶</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§æ–‡æ¡£é¢„è§ˆ -->
        <div class="preview-sidebar" id="previewSidebar">
            <div class="preview-sidebar-header">
                <h2 class="preview-sidebar-title">
                    <span>ğŸ“„</span>
                    <span id="previewDocTitle">æ–‡æ¡£é¢„è§ˆ</span>
                </h2>
                <button class="preview-sidebar-close" onclick="closePreview()">Ã—</button>
            </div>

            <div class="preview-toolbar">
                <div class="toolbar-actions">
                    <button class="preview-btn" title="ä¸‹è½½åŸæ–‡ä»¶">
                        ğŸ’¾ æºæ–‡ä»¶
                    </button>
                    <button class="preview-btn" title="ä¸‹è½½å½“å‰ç‰ˆæœ¬">
                        ğŸ’¾ ä¿®æ”¹ç‰ˆ
                    </button>
                    <button class="preview-btn" title="ç‰ˆæœ¬å†å²">
                        ğŸ• å†å²
                    </button>
                    <button class="preview-btn" title="åˆ·æ–°">
                        ğŸ”„ åˆ·æ–°
                    </button>
                    <button class="preview-btn" title="ç¼–è¾‘">
                        âœï¸ ç¼–è¾‘
                    </button>
                </div>
            </div>

            <div class="preview-content" id="previewContent">
                <h2>åŒå›¾é©±åŠ¨çš„è”æƒ³å¼è®°å¿†å¢é‡æ›´æ–°ç®—æ³•ç ”ç©¶å¼€é¢˜æ„æƒ³</h2>
                
                <h3>ä¸€ã€ç ”ç©¶èƒŒæ™¯ä¸æ„ä¹‰</h3>
                <p>åœ¨äººå·¥æ™ºèƒ½é¢†åŸŸï¼Œè®°å¿†ç®¡ç†ä¸€ç›´æ˜¯æ„å»ºæ™ºèƒ½ç³»ç»Ÿçš„æ ¸å¿ƒæŒ‘æˆ˜ä¹‹ä¸€ã€‚ä¼ ç»Ÿçš„è®°å¿†å­˜å‚¨æ–¹å¼å­˜åœ¨æ•ˆç‡ä½ä¸‹ã€æ£€ç´¢å›°éš¾ç­‰é—®é¢˜ï¼Œéš¾ä»¥æ»¡è¶³å¤æ‚åœºæ™¯ä¸‹çš„å®æ—¶å“åº”éœ€æ±‚ã€‚</p>
                
                <p>æœ¬ç ”ç©¶æå‡ºä¸€ç§åŸºäºåŒå›¾ç»“æ„çš„è”æƒ³å¼è®°å¿†ç®¡ç†æ–¹æ¡ˆï¼Œé€šè¿‡**çŸ¥è¯†å›¾è°±**å’Œ**å…³è”å›¾è°±**çš„ååŒå·¥ä½œï¼Œå®ç°é«˜æ•ˆçš„è®°å¿†å­˜å‚¨ã€æ£€ç´¢å’Œæ›´æ–°æœºåˆ¶ã€‚è¿™ç§æ–¹æ³•èƒ½å¤Ÿæ¨¡æ‹Ÿäººç±»å¤§è„‘çš„è”æƒ³è®°å¿†è¿‡ç¨‹ï¼Œåœ¨ä¿æŒè®°å¿†å®Œæ•´æ€§çš„åŒæ—¶ï¼Œå¤§å¹…æå‡ç³»ç»Ÿçš„å“åº”é€Ÿåº¦ã€‚</p>
                
                <h3>äºŒã€æ ¸å¿ƒåˆ›æ–°ç‚¹</h3>
                <p><strong>1. åŒå›¾é©±åŠ¨æ¶æ„</strong></p>
                <p>â€¢ <strong>çŸ¥è¯†å›¾è°±</strong>ï¼šå­˜å‚¨ç»“æ„åŒ–çš„äº‹å®æ€§çŸ¥è¯†ï¼ŒèŠ‚ç‚¹è¡¨ç¤ºå®ä½“ï¼Œè¾¹è¡¨ç¤ºå…³ç³»</p>
                <p>â€¢ <strong>å…³è”å›¾è°±</strong>ï¼šè®°å½•çŸ¥è¯†é—´çš„è¯­ä¹‰å…³è”å’Œä½¿ç”¨é¢‘ç‡ï¼Œæ”¯æŒè”æƒ³å¼æ£€ç´¢</p>
                
                <p><strong>2. å¢é‡æ›´æ–°æœºåˆ¶</strong></p>
                <p>â€¢ é‡‡ç”¨æ—¶é—´æˆ³å’Œç‰ˆæœ¬æ§åˆ¶ï¼Œæ”¯æŒçŸ¥è¯†çš„æ¸è¿›å¼æ›´æ–°</p>
                <p>â€¢ é€šè¿‡å·®åˆ†ç®—æ³•ï¼Œåªæ›´æ–°å˜åŒ–çš„éƒ¨åˆ†ï¼Œé™ä½è®¡ç®—å¼€é”€</p>
                <p>â€¢ è‡ªåŠ¨ç»´æŠ¤å›¾ç»“æ„çš„ä¸€è‡´æ€§ï¼Œé¿å…å†—ä½™å’Œå†²çª</p>
                
                <p><strong>3. è”æƒ³å¼æ£€ç´¢ç®—æ³•</strong></p>
                <p>â€¢ ç»“åˆPageRankå’Œè¯­ä¹‰ç›¸ä¼¼åº¦ï¼Œè®¡ç®—èŠ‚ç‚¹çš„æ¿€æ´»å¼ºåº¦</p>
                <p>â€¢ æ”¯æŒå¤šè·³æ¨ç†ï¼Œä»åˆå§‹æŸ¥è¯¢æ‰©æ•£åˆ°ç›¸å…³çŸ¥è¯†</p>
                <p>â€¢ åŠ¨æ€è°ƒæ•´æ£€ç´¢æ·±åº¦ï¼Œå¹³è¡¡å‡†ç¡®æ€§å’Œæ•ˆç‡</p>

                <h3>ä¸‰ã€é¢„æœŸæŠ€æœ¯è·¯çº¿</h3>
                <p><strong>é˜¶æ®µä¸€ï¼šå›¾ç»“æ„è®¾è®¡</strong>ï¼ˆ1-2ä¸ªæœˆï¼‰</p>
                <p>â€¢ å®šä¹‰èŠ‚ç‚¹å’Œè¾¹çš„å±æ€§schema</p>
                <p>â€¢ è®¾è®¡å›¾çš„å­˜å‚¨æ ¼å¼å’Œç´¢å¼•æœºåˆ¶</p>
                
                <p><strong>é˜¶æ®µäºŒï¼šç®—æ³•å®ç°</strong>ï¼ˆ2-3ä¸ªæœˆï¼‰</p>
                <p>â€¢ å®ç°åŸºç¡€çš„CRUDæ“ä½œ</p>
                <p>â€¢ å¼€å‘å¢é‡æ›´æ–°ç®—æ³•</p>
                <p>â€¢ æ„å»ºè”æƒ³æ£€ç´¢å¼•æ“</p>
                
                <p><strong>é˜¶æ®µä¸‰ï¼šå®éªŒéªŒè¯</strong>ï¼ˆ2ä¸ªæœˆï¼‰</p>
                <p>â€¢ åœ¨æ ‡å‡†æ•°æ®é›†ä¸Šæµ‹è¯•æ€§èƒ½</p>
                <p>â€¢ å¯¹æ¯”ç°æœ‰æ–¹æ³•çš„ä¼˜åŠ£</p>
                <p>â€¢ ä¼˜åŒ–ç®—æ³•å‚æ•°</p>

                <h3>å››ã€é¢„æœŸæˆæœ</h3>
                <p>1. ä¸€å¥—å®Œæ•´çš„åŒå›¾é©±åŠ¨è®°å¿†ç®¡ç†ç³»ç»ŸåŸå‹</p>
                <p>2. ç›¸å…³ç®—æ³•çš„ç†è®ºåˆ†æå’Œå®éªŒéªŒè¯æŠ¥å‘Š</p>
                <p>3. åœ¨æ£€ç´¢é€Ÿåº¦å’Œå‡†ç¡®ç‡ä¸Šè¾¾åˆ°ä¸šç•Œé¢†å…ˆæ°´å¹³</p>
                <p>4. å‘è¡¨1-2ç¯‡é«˜æ°´å¹³å­¦æœ¯è®ºæ–‡</p>
            </div>
        </div>
    </div>

    <!-- æ–‡ä»¶å¤„ç†é€‰æ‹©æ¨¡æ€æ¡† -->
    <div class="file-processing-modal" id="fileProcessingModal">
        <div class="modal-content">
            <div class="modal-title">æ–‡ä»¶å¤„ç†é€‰æ‹©</div>
            
            <div class="selected-file-info">
                <div class="selected-file-name" id="selectedFileName">æ–‡ä»¶å.pdf</div>
                <div class="selected-file-size" id="selectedFileSize">(0.87MB)</div>
            </div>
            
            <div class="modal-subtitle">è¯·é€‰æ‹©å¤„ç†æ–¹å¼ï¼š</div>
            
            <div class="processing-options">
                <div class="processing-option pdf-parse" onclick="selectProcessingOption('parse')">
                    <div class="option-label">A. PDFè§£æåŠŸèƒ½</div>
                    <div class="option-desc">ä¿å­˜åˆ°çŸ¥è¯†åº“</div>
                </div>
                
                <div class="processing-option template-extract" onclick="selectProcessingOption('template')">
                    <div class="option-label">B. æ¨¡æ¿æŠ½å–åŠŸèƒ½</div>
                    <div class="option-desc">æå–æ–‡æ¡£æ¨¡æ¿</div>
                </div>
            </div>
            
            <button class="modal-close-btn" onclick="closeProcessingModal()">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- ç”Ÿæˆè®¡åˆ’é¢æ¿ -->
    <div class="generation-plan-panel" id="generationPlanPanel">
        <div class="plan-header">
            <div class="plan-title">
                <span>ğŸ“‹</span>
                <span>ç”Ÿæˆè®¡åˆ’</span>
            </div>
            <button class="plan-close" onclick="closePlanPanel()">Ã—</button>
        </div>
        
        <div class="plan-progress">
            <div class="plan-progress-text">
                <span id="planProgressText">å‡†å¤‡ç”Ÿæˆ...</span>
            </div>
            <div class="plan-progress-bar">
                <div class="plan-progress-fill" id="planProgressFill" style="width: 0%"></div>
            </div>
        </div>
        
        <div class="plan-content" id="planContent">
            <!-- è®¡åˆ’é¡¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
        </div>

        <!-- è®¡åˆ’ç¡®è®¤æŒ‰é’® -->
        <div class="plan-confirmation" id="planConfirmation">
            <button class="plan-confirm-btn secondary" onclick="cancelPlan()">
                å–æ¶ˆ
            </button>
            <button class="plan-confirm-btn primary" onclick="confirmPlan()">
                ç¡®è®¤ç”Ÿæˆ
            </button>
        </div>
    </div>

    <script>
        // ========== Agent çŠ¶æ€ç®¡ç† ==========
        let currentAgent = 'main'; // 'main' | 'plan' | 'writer'
        let currentPlan = null; // å­˜å‚¨å½“å‰è®¡åˆ’
        let isGenerating = false; // æ˜¯å¦æ­£åœ¨ç”Ÿæˆ
        let generationPaused = false; // ç”Ÿæˆæ˜¯å¦è¢«æš‚åœ

        // åˆ‡æ¢åˆ° Plan Agent
        function switchToPlanAgent() {
            currentAgent = 'plan';
            const inputArea = document.getElementById('inputArea');
            const indicator = document.getElementById('agentStatusIndicator');
            const badge = document.getElementById('agentBadge');
            const agentName = document.getElementById('agentName');
            const statusText = document.getElementById('agentStatusText');

            inputArea.classList.add('plan-agent-mode');
            indicator.classList.remove('hidden');
            badge.className = 'agent-badge plan-agent';
            agentName.textContent = 'Plan Agent';
            statusText.textContent = 'æ­£åœ¨ä¸ºæ‚¨åˆ¶å®šç”Ÿæˆè®¡åˆ’...';
        }

        // åˆ‡æ¢å› Main Agent
        function switchToMainAgent() {
            currentAgent = 'main';
            const inputArea = document.getElementById('inputArea');
            const indicator = document.getElementById('agentStatusIndicator');

            inputArea.classList.remove('plan-agent-mode');
            indicator.classList.add('hidden');
        }

        // æ›´æ–° Agent çŠ¶æ€æ–‡æœ¬
        function updateAgentStatus(text) {
            const statusText = document.getElementById('agentStatusText');
            statusText.textContent = text;
        }

        // æ ‡ç­¾åˆ‡æ¢
        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.sidebar-tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));
            
            if (tabName === 'files') {
                tabs[0].classList.add('active');
                document.getElementById('filesTab').classList.add('active');
            } else if (tabName === 'history') {
                tabs[1].classList.add('active');
                document.getElementById('historyTab').classList.add('active');
            }
        }

        // æŠ˜å /å±•å¼€æ–‡ä»¶åˆ—è¡¨
        function toggleFilesSection() {
            const section = document.getElementById('filesSection');
            section.classList.toggle('collapsed');
        }

        // æ–‡ä»¶ç‚¹å‡» - æ‰“å¼€é¢„è§ˆé¢æ¿
        document.querySelectorAll('.file-item').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.file-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                
                // è·å–æ–‡ä»¶å
                const fileName = this.querySelector('span:last-child').textContent;
                
                // æ‰“å¼€å³ä¾§é¢„è§ˆé¢æ¿
                openFilePreview(fileName);
            });
        });

        // æ–°å»ºå¯¹è¯
        function startNewChat() {
            document.getElementById('welcomePrompts').style.display = 'none';
            document.getElementById('chatMessages').style.display = 'flex';
        }

        // æ‰“å¼€æ–‡ä»¶é¢„è§ˆ
        function openFilePreview(fileName) {
            const previewSidebar = document.getElementById('previewSidebar');
            const previewDocTitle = document.getElementById('previewDocTitle');
            
            // è®¾ç½®æ–‡ä»¶å
            previewDocTitle.textContent = fileName;
            
            // æ‰“å¼€é¢„è§ˆé¢æ¿
            previewSidebar.classList.add('open');
        }

        // æ‰“å¼€é¢„è§ˆï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰
        function openPreview() {
            document.getElementById('previewSidebar').classList.add('open');
        }

        // å…³é—­é¢„è§ˆ
        function closePreview() {
            document.getElementById('previewSidebar').classList.remove('open');
        }

        // è¾“å…¥æ¡†è‡ªåŠ¨é«˜åº¦
        const inputField = document.getElementById('inputField');
        inputField.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // å‘é€æ¶ˆæ¯
        const sendButton = document.getElementById('sendButton');
        inputField.addEventListener('input', function() {
            sendButton.disabled = this.value.trim() === '';
        });

        sendButton.addEventListener('click', function() {
            const message = inputField.value.trim();
            if (message) {
                // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
                addUserMessage(message);
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                inputField.value = '';
                inputField.style.height = 'auto';
                sendButton.disabled = true;
                
                // æ ¹æ®å½“å‰çŠ¶æ€å¤„ç†æ¶ˆæ¯
                if (isGenerating) {
                    // æ‰§è¡Œé˜¶æ®µçš„å¹²é¢„
                    handleGenerationInterruption(message);
                } else if (currentAgent === 'plan') {
                    // Plan Agent é˜¶æ®µçš„é‡è§„åˆ’
                    handlePlanRegeneration(message);
                } else {
                    // æ™®é€šå¯¹è¯
                    setTimeout(() => {
                        generateAIResponse(message);
                    }, 500);
                }
            }
        });

        // å›è½¦å‘é€
        inputField.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendButton.click();
            }
        });

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            sendButton.disabled = true;
        });

        // ========== æ–‡ä»¶ä¸Šä¼ å¤„ç† ==========
        let selectedFile = null;

        // ç›‘å¬æ–‡ä»¶é€‰æ‹©
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                selectedFile = file;
                showProcessingModal(file);
            }
        });

        // æ˜¾ç¤ºå¤„ç†æ–¹å¼é€‰æ‹©æ¨¡æ€æ¡†
        function showProcessingModal(file) {
            const modal = document.getElementById('fileProcessingModal');
            const fileName = document.getElementById('selectedFileName');
            const fileSize = document.getElementById('selectedFileSize');
            
            fileName.textContent = file.name;
            fileSize.textContent = `(${(file.size / 1024 / 1024).toFixed(2)}MB)`;
            
            modal.classList.add('show');
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeProcessingModal() {
            const modal = document.getElementById('fileProcessingModal');
            modal.classList.remove('show');
            // é‡ç½®æ–‡ä»¶è¾“å…¥
            document.getElementById('fileInput').value = '';
            selectedFile = null;
        }

        // é€‰æ‹©å¤„ç†æ–¹å¼
        function selectProcessingOption(option) {
            // å…ˆä¿å­˜æ–‡ä»¶å¼•ç”¨ï¼Œå†å…³é—­æ¨¡æ€æ¡†
            const fileToProcess = selectedFile;
            closeProcessingModal();
            
            // ç¡®ä¿æ˜¾ç¤ºèŠå¤©æ¶ˆæ¯åŒºåŸŸ
            document.getElementById('welcomePrompts').style.display = 'none';
            document.getElementById('chatMessages').style.display = 'flex';
            
            if (option === 'parse') {
                startPdfParsing(fileToProcess);
            } else if (option === 'template') {
                startTemplateExtraction(fileToProcess);
            }
        }

        // å¼€å§‹PDFè§£æï¼ˆä¿å­˜åˆ°çŸ¥è¯†åº“ï¼‰
        function startPdfParsing(file) {
            const chatMessages = document.getElementById('chatMessages');
            
            // åˆ›å»ºè¿›åº¦æ¶ˆæ¯å®¹å™¨
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai';
            messageDiv.innerHTML = `
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    <div class="upload-progress-message" id="uploadProgress-${Date.now()}">
                        <div class="progress-header">
                            <div class="progress-icon">âš™ï¸</div>
                            <div class="progress-file-name">${file.name}</div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" id="progressBar" style="width: 0%"></div>
                        </div>
                        <div class="progress-status" id="progressStatus">å‡†å¤‡ä¸Šä¼ ...</div>
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // æ¨¡æ‹Ÿå¤„ç†è¿‡ç¨‹
            simulateProcessing(messageDiv, file.name);
        }

        // æ¨¡æ‹Ÿå¤„ç†è¿‡ç¨‹
        function simulateProcessing(messageDiv, fileName) {
            const progressBar = messageDiv.querySelector('#progressBar');
            const progressStatus = messageDiv.querySelector('#progressStatus');
            const progressIcon = messageDiv.querySelector('.progress-icon');
            
            const stages = [
                { progress: 20, status: 'æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...', icon: 'ğŸ“¤', duration: 1000 },
                { progress: 40, status: 'æ–‡ä»¶ä¸Šä¼ å®Œæˆï¼Œå¼€å§‹è§£æ...', icon: 'ğŸ”„', duration: 800 },
                { progress: 60, status: 'æ­£åœ¨æ™ºèƒ½æ‹†è§£æ–‡æ¡£ç»“æ„...', icon: 'ğŸ§©', duration: 1500 },
                { progress: 80, status: 'æ­£åœ¨æå–å…³é”®ä¿¡æ¯...', icon: 'ğŸ”', duration: 1200 },
                { progress: 100, status: 'æ­£åœ¨ä¿å­˜åˆ°çŸ¥è¯†åº“...', icon: 'ğŸ’¾', duration: 1000 }
            ];
            
            let currentStage = 0;
            
            function updateProgress() {
                if (currentStage < stages.length) {
                    const stage = stages[currentStage];
                    progressBar.style.width = stage.progress + '%';
                    progressStatus.textContent = stage.status;
                    progressIcon.textContent = stage.icon;
                    
                    currentStage++;
                    setTimeout(updateProgress, stage.duration);
                } else {
                    // å¤„ç†å®Œæˆï¼Œæ›¿æ¢ä¸ºå®Œæˆæ¶ˆæ¯
                    setTimeout(() => {
                        const uploadProgressDiv = messageDiv.querySelector('.upload-progress-message');
                        uploadProgressDiv.outerHTML = `
                            <div class="upload-complete-message">
                                <div class="complete-header">
                                    <div class="complete-icon">âœ…</div>
                                    <div class="complete-text">æ–‡ä»¶å¤„ç†å®Œæˆï¼</div>
                                </div>
                                <div class="complete-file-name">${fileName} å·²æˆåŠŸä¿å­˜åˆ°çŸ¥è¯†åº“</div>
                            </div>
                        `;
                    }, 500);
                }
            }
            
            updateProgress();
        }

        // å¼€å§‹æ¨¡æ¿æŠ½å–
        function startTemplateExtraction(file) {
            const chatMessages = document.getElementById('chatMessages');
            
            // åˆ›å»ºè¿›åº¦æ¶ˆæ¯å®¹å™¨
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai';
            messageDiv.innerHTML = `
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    <div class="upload-progress-message" id="uploadProgress-${Date.now()}">
                        <div class="progress-header">
                            <div class="progress-icon">âš™ï¸</div>
                            <div class="progress-file-name">${file.name}</div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" id="progressBar" style="width: 0%"></div>
                        </div>
                        <div class="progress-status" id="progressStatus">å‡†å¤‡å¤„ç†...</div>
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // æ¨¡æ‹Ÿæ¨¡æ¿æŠ½å–è¿‡ç¨‹
            simulateTemplateExtraction(messageDiv, file.name);
        }

        // æ¨¡æ‹Ÿæ¨¡æ¿æŠ½å–è¿‡ç¨‹
        function simulateTemplateExtraction(messageDiv, fileName) {
            const progressBar = messageDiv.querySelector('#progressBar');
            const progressStatus = messageDiv.querySelector('#progressStatus');
            const progressIcon = messageDiv.querySelector('.progress-icon');
            
            const stages = [
                { progress: 25, status: 'æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...', icon: 'ğŸ“¤', duration: 1000 },
                { progress: 50, status: 'æ­£åœ¨åˆ†ææ–‡æ¡£ç»“æ„...', icon: 'ğŸ”', duration: 1200 },
                { progress: 75, status: 'æ­£åœ¨æå–æ¨¡æ¿å…ƒç´ ...', icon: 'ğŸ“‹', duration: 1500 },
                { progress: 100, status: 'æ­£åœ¨ç”Ÿæˆæ¨¡æ¿æ•°æ®...', icon: 'âœ¨', duration: 1000 }
            ];
            
            let currentStage = 0;
            
            function updateProgress() {
                if (currentStage < stages.length) {
                    const stage = stages[currentStage];
                    progressBar.style.width = stage.progress + '%';
                    progressStatus.textContent = stage.status;
                    progressIcon.textContent = stage.icon;
                    
                    currentStage++;
                    setTimeout(updateProgress, stage.duration);
                } else {
                    // å¤„ç†å®Œæˆ
                    setTimeout(() => {
                        const uploadProgressDiv = messageDiv.querySelector('.upload-progress-message');
                        uploadProgressDiv.outerHTML = `
                            <div class="upload-complete-message">
                                <div class="complete-header">
                                    <div class="complete-icon">âœ…</div>
                                    <div class="complete-text">æ¨¡æ¿æŠ½å–å®Œæˆï¼</div>
                                </div>
                                <div class="complete-file-name">${fileName} çš„æ¨¡æ¿å·²æˆåŠŸç”Ÿæˆ</div>
                            </div>
                        `;
                    }, 500);
                }
            }
            
            updateProgress();
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
        document.getElementById('fileProcessingModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeProcessingModal();
            }
        });

        // ========== AI å¯¹è¯ç³»ç»Ÿ ==========
        
        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        function addUserMessage(text) {
            // ç¡®ä¿æ˜¾ç¤ºèŠå¤©æ¶ˆæ¯åŒºåŸŸ
            document.getElementById('welcomePrompts').style.display = 'none';
            document.getElementById('chatMessages').style.display = 'flex';
            
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            messageDiv.innerHTML = `
                <div class="message-avatar">U</div>
                <div class="message-content">
                    <div class="message-text">${escapeHtml(text)}</div>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        // ç”ŸæˆAIå“åº”ï¼ˆéšæœºé€‰æ‹©3ä¸ªæ¨¡æ¿ä¹‹ä¸€ï¼‰
        function generateAIResponse(userMessage) {
            const responses = [
                generateDocumentResponse,
                generateResearchResponse,
                generateAnalysisResponse
            ];
            
            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
            randomResponse(userMessage);
        }

        // å“åº”1: æ–‡æ¡£ç”Ÿæˆä»»åŠ¡ï¼ˆç®€å•æ€è€ƒï¼‰
        function generateDocumentResponse(userMessage) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai';
            messageDiv.innerHTML = `
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    <div class="thinking-container" id="thinking-${Date.now()}">
                        <div class="thinking-header" onclick="toggleThinking(this)">
                            <div class="thinking-title">
                                <span class="thinking-icon">ğŸ¤”</span>
                                <span>æ€è€ƒä¸­...</span>
                            </div>
                            <span class="thinking-toggle">â–¼</span>
                        </div>
                        <div class="thinking-content">
                            <div id="think-content"></div>
                        </div>
                    </div>
                    <div class="ai-response-text" id="ai-response-${Date.now()}"></div>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();

            const thinkContent = messageDiv.querySelector('#think-content');
            const responseText = messageDiv.querySelector('[id^="ai-response-"]');
            const thinkingContainer = messageDiv.querySelector('.thinking-container');

            // æ€è€ƒè¿‡ç¨‹ - è‡ªç„¶æµ
            const thinking = `æ”¶åˆ°ç”¨æˆ·è¯·æ±‚ï¼š"${userMessage}"\n\nè¿™æ˜¯ä¸€ä¸ªæ–‡æ¡£ç”Ÿæˆä»»åŠ¡...éœ€è¦ç¡®å®šæ–‡æ¡£ç±»å‹å’Œç»“æ„\n\nè®©æˆ‘åˆ†æä¸€ä¸‹ï¼š\n- è¿™åº”è¯¥æ˜¯ä¸€ä»½æŠ€æœ¯æ€§æ–‡æ¡£\n- éœ€è¦åŒ…å«èƒŒæ™¯ã€æ ¸å¿ƒå†…å®¹ã€å®æ–½æ–¹æ¡ˆ\n- ç»“æ„åº”è¯¥æ¸…æ™°ï¼Œåˆ†ä¸ºå‡ ä¸ªä¸»è¦éƒ¨åˆ†\n\nå¥½çš„ï¼Œæˆ‘çŸ¥é“è¯¥æ€ä¹ˆåšäº†ï¼Œå¼€å§‹ç»„ç»‡å†…å®¹æ¡†æ¶`;
            
            typeText(thinkContent, thinking, 15, () => {
                // æ€è€ƒå®Œæˆï¼Œç«‹å³æ›´æ–°æ ‡é¢˜
                const thinkingTitle = thinkingContainer.querySelector('.thinking-title span:last-child');
                thinkingTitle.textContent = 'æ€è€ƒè¿‡ç¨‹';
                
                // ç„¶åå¼€å§‹ç”Ÿæˆå“åº”
                setTimeout(() => {
                    const response = `å¥½çš„ï¼æˆ‘å°†ä¸ºæ‚¨ç”Ÿæˆå…³äº"${userMessage}"çš„è¯¦ç»†æ–‡æ¡£ã€‚\n\nåŸºäºæ‚¨çš„éœ€æ±‚ï¼Œæˆ‘å°†ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢å±•å¼€ï¼š\n\n1. **èƒŒæ™¯ä»‹ç»**ï¼šé˜è¿°ç›¸å…³èƒŒæ™¯å’Œé‡è¦æ€§\n2. **æ ¸å¿ƒå†…å®¹**ï¼šè¯¦ç»†åˆ†æå…³é”®è¦ç‚¹\n3. **å®æ–½æ–¹æ¡ˆ**ï¼šæä¾›å¯è¡Œçš„è§£å†³æ–¹æ¡ˆ\n4. **æ€»ç»“å»ºè®®**ï¼šå½’çº³è¦ç‚¹å¹¶ç»™å‡ºå»ºè®®\n\næ–‡æ¡£æ­£åœ¨ç”Ÿæˆä¸­ï¼Œé¢„è®¡3-5åˆ†é’Ÿå®Œæˆã€‚æ‚¨å¯ä»¥ç»§ç»­è¿›è¡Œå…¶ä»–æ“ä½œï¼Œå®Œæˆåæˆ‘ä¼šé€šçŸ¥æ‚¨ã€‚`;
                    
                    typeText(responseText, response, 20, () => {
                        // å“åº”å®Œæˆï¼ŒæŠ˜å æ€è€ƒè¿‡ç¨‹
                        setTimeout(() => {
                            thinkingContainer.classList.add('collapsed');
                        }, 500);
                    });
                }, 300);
            });
        }

        // å“åº”2: å¤æ‚ç ”ç©¶ä»»åŠ¡ï¼ˆ3è½®æ€è€ƒï¼Œæ¨¡æ‹ŸReActï¼‰
        function generateResearchResponse(userMessage) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai';
            messageDiv.innerHTML = `
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    <div class="thinking-container" id="thinking-${Date.now()}">
                        <div class="thinking-header" onclick="toggleThinking(this)">
                            <div class="thinking-title">
                                <span class="thinking-icon">ğŸ¤”</span>
                                <span>æ€è€ƒä¸­...</span>
                            </div>
                            <span class="thinking-toggle">â–¼</span>
                        </div>
                        <div class="thinking-content">
                            <div class="thinking-step">
                                <div id="think-step-1"></div>
                            </div>
                            <div class="thinking-step">
                                <div id="think-step-2"></div>
                            </div>
                            <div class="thinking-step">
                                <div id="think-step-3"></div>
                            </div>
                        </div>
                    </div>
                    <div class="ai-response-text" id="ai-response-${Date.now()}"></div>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();

            const thinkStep1 = messageDiv.querySelector('#think-step-1');
            const thinkStep2 = messageDiv.querySelector('#think-step-2');
            const thinkStep3 = messageDiv.querySelector('#think-step-3');
            const responseText = messageDiv.querySelector('[id^="ai-response-"]');
            const thinkingContainer = messageDiv.querySelector('.thinking-container');

            // æ€è€ƒé˜¶æ®µ1
            const thinking1 = `ç”¨æˆ·è¾“å…¥ï¼š"${userMessage}"\n\nå—¯...è¿™çœ‹èµ·æ¥æ˜¯ä¸€ä¸ªéœ€è¦æ·±åº¦ç ”ç©¶çš„é—®é¢˜\n\næˆ‘éœ€è¦å…ˆç†è§£æ¸…æ¥šï¼š\n- è¿™ä¸ªä»»åŠ¡çš„æ ¸å¿ƒç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿ\n- éœ€è¦æŸ¥é˜…å“ªäº›èµ„æ–™ï¼Ÿ\n- æ¶‰åŠå“ªäº›å…³é”®ç»´åº¦ï¼Ÿ\n\nçœ‹èµ·æ¥éœ€è¦ç³»ç»Ÿæ€§çš„åˆ†ææ–¹æ³•`;
            
            typeText(thinkStep1, thinking1, 15, () => {
                setTimeout(() => {
                    // æ€è€ƒé˜¶æ®µ2
                    const thinking2 = `å¥½ï¼Œç°åœ¨æˆ‘è¦åˆ¶å®šå…·ä½“çš„æ‰§è¡Œç­–ç•¥...\n\nè®©æˆ‘æƒ³æƒ³æœ€ä½³çš„ç ”ç©¶è·¯å¾„ï¼š\n\né¦–å…ˆï¼Œæ”¶é›†ç›¸å…³çš„æ–‡çŒ®å’Œèµ„æ–™\nç„¶åï¼Œè¿›è¡Œæ¨ªå‘å’Œçºµå‘çš„å¯¹æ¯”åˆ†æ\næ¥ç€ï¼Œæç‚¼å‡ºæ ¸å¿ƒè§‚ç‚¹å’Œè®ºæ®\næœ€åï¼Œæ„å»ºä¸€ä¸ªæ¸…æ™°çš„è®ºè¯æ¡†æ¶\n\nè¿™æ ·åº”è¯¥èƒ½å¤Ÿå…¨é¢è¦†ç›–è¿™ä¸ªä¸»é¢˜`;
                    
                    typeText(thinkStep2, thinking2, 15, () => {
                        setTimeout(() => {
                            // æ€è€ƒé˜¶æ®µ3
                            const thinking3 = `ç­‰ç­‰ï¼Œè®©æˆ‘å†æ£€æŸ¥ä¸€ä¸‹è¿™ä¸ªæ–¹æ¡ˆ...\n\né€»è¾‘æ˜¯å¦å®Œæ•´ï¼Ÿçœ‹èµ·æ¥æ²¡é—®é¢˜ âœ“\nå¯è¡Œæ€§å¦‚ä½•ï¼Ÿåº”è¯¥æ˜¯å¯ä»¥åšåˆ°çš„\nè¾“å‡ºæ ¼å¼ï¼Ÿæœ€å¥½æ˜¯ç»“æ„åŒ–çš„æŠ¥å‘Šå½¢å¼\n\nå¥½çš„ï¼Œæˆ‘ç°åœ¨æ¸…æ¥šè¯¥æ€ä¹ˆå¤„ç†äº†`;
                            
                            typeText(thinkStep3, thinking3, 15, () => {
                                // æ€è€ƒå®Œæˆï¼Œç«‹å³æ›´æ–°æ ‡é¢˜
                                const thinkingTitle = thinkingContainer.querySelector('.thinking-title span:last-child');
                                thinkingTitle.textContent = 'æ€è€ƒè¿‡ç¨‹';
                                
                                setTimeout(() => {
                                    // ç”Ÿæˆå“åº”
                                    const response = `ç»è¿‡æ·±åº¦åˆ†æï¼Œæˆ‘å·²ç»ä¸º"${userMessage}"åˆ¶å®šäº†å®Œæ•´çš„ç ”ç©¶æ–¹æ¡ˆã€‚\n\n**ç ”ç©¶æ¡†æ¶ï¼š**\n\nğŸ“Š **æ•°æ®æ”¶é›†é˜¶æ®µ**\n- å·²æ£€ç´¢çŸ¥è¯†åº“ä¸­ç›¸å…³æ–‡æ¡£ 15 ä»½\n- æå–å…³é”®ä¿¡æ¯ç‚¹ 23 ä¸ª\n\nğŸ”¬ **åˆ†æé˜¶æ®µ**\n- å¤šç»´åº¦å¯¹æ¯”åˆ†æ\n- è¯†åˆ«æ ¸å¿ƒçŸ›ç›¾ä¸æœºä¼š\n\nğŸ“ **è¾“å‡ºé˜¶æ®µ**\n- ç”Ÿæˆç»“æ„åŒ–ç ”ç©¶æŠ¥å‘Š\n- æä¾›å¯æ‰§è¡Œå»ºè®®\n\næ‚¨å¸Œæœ›æˆ‘ç«‹å³å¼€å§‹ç”Ÿæˆè¯¦ç»†æŠ¥å‘Šï¼Œè¿˜æ˜¯å…ˆä¸ºæ‚¨å±•ç¤ºç ”ç©¶å¤§çº²ï¼Ÿ`;
                                    
                                    typeText(responseText, response, 20, () => {
                                        // å“åº”å®Œæˆï¼ŒæŠ˜å æ€è€ƒè¿‡ç¨‹
                                        setTimeout(() => {
                                            thinkingContainer.classList.add('collapsed');
                                        }, 500);
                                    });
                                }, 300);
                            });
                        }, 400);
                    });
                }, 400);
            });
        }

        // å“åº”3: åˆ†æç±»ä»»åŠ¡ï¼ˆ2è½®æ€è€ƒï¼‰
        function generateAnalysisResponse(userMessage) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai';
            messageDiv.innerHTML = `
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    <div class="thinking-container" id="thinking-${Date.now()}">
                        <div class="thinking-header" onclick="toggleThinking(this)">
                            <div class="thinking-title">
                                <span class="thinking-icon">ğŸ¤”</span>
                                <span>æ€è€ƒä¸­...</span>
                            </div>
                            <span class="thinking-toggle">â–¼</span>
                        </div>
                        <div class="thinking-content">
                            <div class="thinking-step">
                                <div id="think-step-1"></div>
                            </div>
                            <div class="thinking-step">
                                <div id="think-step-2"></div>
                            </div>
                        </div>
                    </div>
                    <div class="ai-response-text" id="ai-response-${Date.now()}"></div>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();

            const thinkStep1 = messageDiv.querySelector('#think-step-1');
            const thinkStep2 = messageDiv.querySelector('#think-step-2');
            const responseText = messageDiv.querySelector('[id^="ai-response-"]');
            const thinkingContainer = messageDiv.querySelector('.thinking-container');

            // æ€è€ƒé˜¶æ®µ1
            const thinking1 = `çœ‹åˆ°é—®é¢˜ï¼š"${userMessage}"\n\nè¿™éœ€è¦åˆ†æå’Œæ´å¯Ÿ...è®©æˆ‘æƒ³æƒ³\n\næˆ‘è§‰å¾—æ ¸å¿ƒæ˜¯è¦åšæ•°æ®åˆ†æï¼Œéš¾åº¦åº”è¯¥æ˜¯ä¸­ç­‰çš„\n\nå¯ä»¥æŠŠè¿™ä¸ªä»»åŠ¡æ‹†åˆ†æˆå‡ ä¸ªæ­¥éª¤ï¼š\n- å…ˆæ•´ç†ç°æœ‰çš„æ•°æ®\n- ç„¶ååˆ†æå…¶ä¸­çš„è¶‹åŠ¿\n- æœ€åå¾—å‡ºç»“è®ºå’Œå»ºè®®`;
            
            typeText(thinkStep1, thinking1, 15, () => {
                setTimeout(() => {
                    // æ€è€ƒé˜¶æ®µ2
                    const thinking2 = `ç°åœ¨æ¥è®¾è®¡è§£å†³æ–¹æ¡ˆ...\n\næˆ‘å¯ä»¥é‡‡ç”¨MECEæ¡†æ¶æ¥ç¡®ä¿åˆ†æçš„å…¨é¢æ€§\nç”¨å¯è§†åŒ–çš„æ–¹å¼ä¼šæ›´ç›´è§‚\næœ€å¥½èƒ½ç»™å‡º3-5æ¡å¯æ‰§è¡Œçš„å»ºè®®\n\nä¼°è®¡å¤§æ¦‚2åˆ†é’Ÿå°±èƒ½å®Œæˆè¿™ä¸ªåˆ†æ`;
                    
                    typeText(thinkStep2, thinking2, 15, () => {
                        // æ€è€ƒå®Œæˆï¼Œç«‹å³æ›´æ–°æ ‡é¢˜
                        const thinkingTitle = thinkingContainer.querySelector('.thinking-title span:last-child');
                        thinkingTitle.textContent = 'æ€è€ƒè¿‡ç¨‹';
                        
                        setTimeout(() => {
                            // ç”Ÿæˆå“åº”
                            const response = `æˆ‘æ¥å¸®æ‚¨åˆ†æ"${userMessage}"è¿™ä¸ªé—®é¢˜ã€‚\n\n**å¿«é€Ÿæ´å¯Ÿï¼š**\n\nâœ¨ **æ ¸å¿ƒå‘ç°**\næ ¹æ®å½“å‰æ•°æ®å’Œè¶‹åŠ¿ï¼Œæˆ‘è¯†åˆ«å‡º3ä¸ªå…³é”®ç‚¹ï¼š\n\n1. **æœºä¼šç‚¹**ï¼šå­˜åœ¨æ˜æ˜¾çš„ä¼˜åŒ–ç©ºé—´\n2. **é£é™©ç‚¹**ï¼šéœ€è¦æ³¨æ„æ½œåœ¨çš„æŒ‘æˆ˜\n3. **å»ºè®®**ï¼šå¯ä»¥ä»è¿™å‡ ä¸ªæ–¹å‘å…¥æ‰‹æ”¹è¿›\n\n**è¯¦ç»†åˆ†æ**\n\næˆ‘å¯ä»¥ä¸ºæ‚¨ç”Ÿæˆä¸€ä»½å®Œæ•´çš„åˆ†ææŠ¥å‘Šï¼ŒåŒ…å«ï¼š\n- ğŸ“ˆ æ•°æ®å¯è§†åŒ–å›¾è¡¨\n- ğŸ“Š è¯¦ç»†çš„è¶‹åŠ¿åˆ†æ\n- ğŸ’¡ å¯æ‰§è¡Œçš„æ”¹è¿›å»ºè®®\n\néœ€è¦æˆ‘ç°åœ¨å¼€å§‹ç”Ÿæˆå—ï¼Ÿ`;
                            
                            typeText(responseText, response, 20, () => {
                                // å“åº”å®Œæˆï¼ŒæŠ˜å æ€è€ƒè¿‡ç¨‹
                                setTimeout(() => {
                                    thinkingContainer.classList.add('collapsed');
                                }, 500);
                            });
                        }, 300);
                    });
                }, 400);
            });
        }

        // æµå¼æ‰“å­—æ•ˆæœ
        function typeText(element, text, speed, callback) {
            let index = 0;
            const cursor = document.createElement('span');
            cursor.className = 'typing-cursor';
            element.appendChild(cursor);
            
            function type() {
                if (index < text.length) {
                    const char = text.charAt(index);
                    const textNode = document.createTextNode(char);
                    element.insertBefore(textNode, cursor);
                    index++;
                    scrollToBottom();
                    setTimeout(type, speed);
                } else {
                    cursor.remove();
                    if (callback) callback();
                }
            }
            
            type();
        }

        // åˆ‡æ¢æ€è€ƒè¿‡ç¨‹æ˜¾ç¤º/éšè—
        function toggleThinking(headerElement) {
            const container = headerElement.closest('.thinking-container');
            container.classList.toggle('collapsed');
        }

        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // åŠ è½½å†å²å¯¹è¯
        function loadHistoryChat(title) {
            // æ¸…ç©ºå½“å‰å¯¹è¯
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '<!-- å¯¹è¯æ¶ˆæ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->';
            
            // æ˜¾ç¤ºå¯¹è¯åŒºåŸŸ
            document.getElementById('welcomePrompts').style.display = 'none';
            document.getElementById('chatMessages').style.display = 'flex';
            
            // Demoæç¤º
            alert(`Demoæ¨¡å¼ï¼šåŠ è½½å†å²å¯¹è¯ "${title}"\n\nå®é™…ä½¿ç”¨æ—¶ä¼šä»æœåŠ¡å™¨åŠ è½½å†å²è®°å½•`);
        }

        // ========== æ–‡æ¡£ç”Ÿæˆç³»ç»Ÿ ==========
        
        // æ¨¡æ¿æ•°æ®
        const TEMPLATES = [
            {
                id: '7862401b-4e59-41c8-97ca-4351d980f4d7',
                name: 'å¼€é¢˜æŠ¥å‘Šæ¨¡æ¿',
                match: 77.6,
                sections: 6,
                structure: [
                    '1. ç ”ç©¶ç”Ÿå­¦ä½è®ºæ–‡å¼€é¢˜æŠ¥å‘Š',
                    '   â€¢ å°é¢é¡µ',
                    '2. ä¸€ã€ç«‹é¢˜ä¾æ®',
                    '   â€¢ 1.1 ç ”ç©¶ç›®çš„ä¸æ„ä¹‰',
                    '   â€¢ 1.2 å›½å†…å¤–å‘å±•ç°çŠ¶ä¸ç ”ç©¶è¶‹åŠ¿',
                    '   â€¢ å‚è€ƒæ–‡çŒ®',
                    '3. äºŒã€ç ”ç©¶å†…å®¹å’Œç›®æ ‡',
                    '   â€¢ 2.1 ç ”ç©¶å†…å®¹',
                    '   â€¢ 2.2 ç ”ç©¶ç›®æ ‡å’Œæ‹Ÿè§£å†³çš„å…³é”®é—®é¢˜',
                    '   â€¢ 2.3 æ‹Ÿè§£å†³å…³é”®ç§‘å­¦é—®é¢˜',
                    '4. ä¸‰ã€ç ”ç©¶æ–¹æ¡ˆè®¾è®¡åŠå¯è¡Œæ€§åˆ†æ',
                    '   â€¢ 3.1 ç ”ç©¶æ–¹æ³•',
                    '   â€¢ 3.2 æŠ€æœ¯è·¯çº¿',
                    '   â€¢ 3.3 ç†è®ºåˆ†æä¸è®¡ç®—',
                    '   â€¢ 3.4 å®éªŒæ–¹æ¡ˆä¸æ­¥éª¤',
                    '   â€¢ 3.5 å¯è¡Œæ€§åˆ†æ',
                    '5. å››ã€é¢„æœŸç ”ç©¶æˆæœã€åˆ›æ–°ç‚¹åŠåº”ç”¨å‰æ™¯',
                    '6. äº”ã€ç ”ç©¶å·¥ä½œè®¡åˆ’ä¸ç ”ç©¶ç»è´¹',
                ],
                plan: [
                    {
                        title: 'äºŒã€ç ”ç©¶å†…å®¹å’Œç›®æ ‡',
                        desc: 'æ˜ç¡®ç ”ç©¶çš„æ ¸å¿ƒé—®é¢˜å’Œé¢„æœŸç›®æ ‡ï¼ŒåŒ…æ‹¬åŒå›¾ç»“æ„è®¾è®¡ã€å¢é‡æ›´æ–°æœºåˆ¶å’Œè”æƒ³æ£€ç´¢ç®—æ³•ä¸‰ä¸ªä¸»è¦ç ”ç©¶å†…å®¹',
                        isCore: true,
                        order: 1
                    },
                    {
                        title: 'ä¸€ã€ç«‹é¢˜ä¾æ®',
                        desc: 'é˜è¿°ç ”ç©¶èƒŒæ™¯ã€æ„ä¹‰ä¸å›½å†…å¤–ç°çŠ¶ï¼Œè¯´æ˜ä¸ºä»€ä¹ˆè¦è¿›è¡Œå›¾é©±åŠ¨è®°å¿†ç®¡ç†ç ”ç©¶ï¼Œå½“å‰æŠ€æœ¯çš„ä¸è¶³ä¹‹å¤„',
                        isCore: true,
                        order: 2
                    },
                    {
                        title: 'ä¸‰ã€ç ”ç©¶æ–¹æ¡ˆè®¾è®¡',
                        desc: 'è¯¦ç»†è¯´æ˜æŠ€æœ¯è·¯çº¿å’Œå®ç°æ–¹æ³•ï¼ŒåŒ…æ‹¬å›¾ç»“æ„schemaè®¾è®¡ã€å¢é‡æ›´æ–°ç®—æ³•å’Œè”æƒ³æ£€ç´¢å¼•æ“çš„å…·ä½“å®ç°æ–¹æ¡ˆ',
                        isCore: true,
                        order: 3
                    },
                    {
                        title: 'å››ã€é¢„æœŸæˆæœä¸åˆ›æ–°ç‚¹',
                        desc: 'åˆ—å‡ºé¢„æœŸäº¤ä»˜çš„æˆæœå’Œæœ¬ç ”ç©¶çš„åˆ›æ–°ä¹‹å¤„ï¼ŒåŒ…æ‹¬ç³»ç»ŸåŸå‹ã€è®ºæ–‡å‘è¡¨å’Œæ€§èƒ½æŒ‡æ ‡',
                        isCore: false,
                        order: 4
                    },
                    {
                        title: 'äº”ã€å·¥ä½œè®¡åˆ’ä¸ç»è´¹',
                        desc: 'åˆ¶å®šè¯¦ç»†çš„æ—¶é—´å®‰æ’å’Œé¢„ç®—è¯´æ˜ï¼ŒåŒ…æ‹¬å„é˜¶æ®µçš„ä»»åŠ¡åˆ†é…å’Œèµ„æºéœ€æ±‚',
                        isCore: false,
                        order: 5
                    },
                    {
                        title: 'å°é¢ä¸åŸºæœ¬ä¿¡æ¯',
                        desc: 'å¡«å†™åŸºæœ¬çš„é¡¹ç›®ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ ‡é¢˜ã€ç ”ç©¶ç”Ÿå§“åã€å¯¼å¸ˆã€å­¦é™¢ç­‰å¿…è¦ä¿¡æ¯',
                        isCore: false,
                        order: 6
                    }
                ]
            },
            {
                id: '2122695e-78dc-46d8-a288-baf1500d5657',
                name: 'ç¡•å£«ç ”ç©¶ç”Ÿå­¦ä½è®ºæ–‡å¼€é¢˜æŠ¥å‘Š',
                match: 76.1,
                sections: 5,
                structure: [
                    '1. å°é¢',
                    '2. é€‰é¢˜ä¾æ®',
                    '3. ç ”ç©¶æ–¹æ¡ˆ',
                    '4. ç ”ç©¶åŸºç¡€',
                    '5. å‚è€ƒæ–‡çŒ®'
                ],
                plan: []
            },
            {
                id: '31844e12-24ee-469c-84c8-e7ccbddcdcf3',
                name: 'æ”¿åºœæŠ•èµ„é¡¹ç›®å¯è¡Œæ€§ç ”ç©¶æŠ¥å‘Š',
                match: 55.3,
                sections: 11,
                structure: [
                    '1. é¡¹ç›®æ¦‚å†µ',
                    '2. é¡¹ç›®å»ºè®¾å¿…è¦æ€§',
                    '3. éœ€æ±‚åˆ†æä¸å»ºè®¾è§„æ¨¡',
                    '4. é¡¹ç›®é€‰å€ä¸å»ºè®¾æ¡ä»¶',
                    '5. æŠ€æœ¯æ–¹æ¡ˆ',
                    '...'
                ],
                plan: []
            }
        ];

        // ä¿®æ”¹åŸæœ‰çš„generateAIResponseï¼Œæ·»åŠ æ„å›¾è¯†åˆ«
        const originalGenerateAIResponse = generateAIResponse;
        window.generateAIResponse = function(userMessage) {
            // æ£€æµ‹æ˜¯å¦åŒ…å«"ç”Ÿæˆ"å’Œ"æŠ¥å‘Š"å…³é”®è¯
            if ((userMessage.includes('ç”Ÿæˆ') || userMessage.includes('å†™') || userMessage.includes('å¸®æˆ‘')) && 
                (userMessage.includes('æŠ¥å‘Š') || userMessage.includes('å¼€é¢˜') || userMessage.includes('æ–‡æ¡£'))) {
                // è§¦å‘æ–‡æ¡£ç”Ÿæˆæµç¨‹
                handleDocumentGenerationRequest(userMessage);
            } else {
                // ä½¿ç”¨åŸæœ‰çš„å¯¹è¯åŠŸèƒ½
                originalGenerateAIResponse(userMessage);
            }
        };

        // å¤„ç†æ–‡æ¡£ç”Ÿæˆè¯·æ±‚
        function handleDocumentGenerationRequest(userMessage) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai';
            messageDiv.innerHTML = `
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    <div class="thinking-container">
                        <div class="thinking-header" onclick="toggleThinking(this)">
                            <div class="thinking-title">
                                <span class="thinking-icon">ğŸ¤”</span>
                                <span>æ€è€ƒä¸­...</span>
                            </div>
                            <span class="thinking-toggle">â–¼</span>
                        </div>
                        <div class="thinking-content">
                            <div id="intent-thinking"></div>
                        </div>
                    </div>
                    <div class="ai-response-text" id="template-recommendations-container"></div>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();

            const thinkContent = messageDiv.querySelector('#intent-thinking');
            const responseContainer = messageDiv.querySelector('#template-recommendations-container');
            const thinkingContainer = messageDiv.querySelector('.thinking-container');

            // æ€è€ƒè¿‡ç¨‹
            const thinking = `æ”¶åˆ°ç”¨æˆ·è¯·æ±‚ï¼š"${userMessage}"\n\næ£€æµ‹åˆ°å…³é”®è¯ï¼šç”Ÿæˆ + æŠ¥å‘Š\nâ†’ åˆ¤æ–­ä»»åŠ¡ç±»å‹ï¼šé•¿æ–‡æ¡£ç”Ÿæˆ\nâ†’ éœ€è¦çš„å·¥å…·ï¼šæ–‡æ¡£ç”Ÿæˆå™¨\n\nè®©æˆ‘æ£€ç´¢çŸ¥è¯†åº“ä¸­çš„æ¨¡æ¿...\n\nå·²æ£€ç´¢åˆ° 3 ä¸ªç›¸å…³æ¨¡æ¿ï¼š\n- å¼€é¢˜æŠ¥å‘Šæ¨¡æ¿ â†’ 77.6% åŒ¹é… âœ“\n- ç¡•å£«ç ”ç©¶ç”Ÿå­¦ä½è®ºæ–‡å¼€é¢˜æŠ¥å‘Š â†’ 76.1% åŒ¹é…\n- æ”¿åºœæŠ•èµ„é¡¹ç›®å¯è¡Œæ€§ç ”ç©¶æŠ¥å‘Š â†’ 55.3% åŒ¹é…\n\nå¥½çš„ï¼Œæˆ‘å°†å‘ç”¨æˆ·æ¨èè¿™äº›æ¨¡æ¿`;
            
            typeText(thinkContent, thinking, 15, () => {
                // æ€è€ƒå®Œæˆ
                const thinkingTitle = thinkingContainer.querySelector('.thinking-title span:last-child');
                thinkingTitle.textContent = 'æ€è€ƒè¿‡ç¨‹';
                
                setTimeout(() => {
                    // ç›´æ¥æ˜¾ç¤ºæ¨¡æ¿æ¨èï¼ˆMain Agent çš„è¾“å‡ºï¼‰
                    showTemplateRecommendations(responseContainer);
                    
                    // æŠ˜å  Main Agent æ€è€ƒè¿‡ç¨‹
                    setTimeout(() => {
                        thinkingContainer.classList.add('collapsed');
                    }, 500);
                }, 300);
            });
        }

        // æ·»åŠ  Agent åˆ‡æ¢æç¤ºæ¶ˆæ¯
        function addAgentSwitchMessage() {
            const chatMessages = document.getElementById('chatMessages');
            const switchDiv = document.createElement('div');
            switchDiv.className = 'message ai';
            switchDiv.innerHTML = `
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    <div class="message-text" style="background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); 
                                                      border-left: 3px solid var(--primary-color); 
                                                      padding: 12px 16px; 
                                                      border-radius: 8px;
                                                      font-size: 13px;
                                                      color: var(--primary-color);
                                                      font-weight: 500;">
                        ğŸ”„ çŠ¶æ€åˆ‡æ¢ï¼šMain Agent â†’ Plan Agent
                    </div>
                </div>
            `;
            chatMessages.appendChild(switchDiv);
            scrollToBottom();
        }

        // Plan Agent åŸºäºç”¨æˆ·é€‰æ‹©çš„æ¨¡æ¿è¿›è¡Œæ€è€ƒå¹¶åˆ¶å®šè®¡åˆ’
        function showPlanAgentThinkingAndPlan(template) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai';
            messageDiv.innerHTML = `
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    <div class="thinking-container">
                        <div class="thinking-header" onclick="toggleThinking(this)">
                            <div class="thinking-title">
                                <span class="thinking-icon">ğŸ¤”</span>
                                <span>Plan Agent æ€è€ƒä¸­...</span>
                            </div>
                            <span class="thinking-toggle">â–¼</span>
                        </div>
                        <div class="thinking-content">
                            <div id="plan-agent-thinking"></div>
                        </div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();

            const thinkContent = messageDiv.querySelector('#plan-agent-thinking');
            const thinkingContainer = messageDiv.querySelector('.thinking-container');

            const thinking = `æ¥æ‰‹ä»»åŠ¡ï¼šåŸºäº"${template.name}"åˆ¶å®šç”Ÿæˆè®¡åˆ’\n\nè®©æˆ‘åˆ†æè¿™ä¸ªæ¨¡æ¿çš„ç»“æ„...\n\næ¨¡æ¿ä¿¡æ¯ï¼š\n- ç« èŠ‚æ•°ï¼š${template.plan.length}\n- æ ¸å¿ƒç« èŠ‚ï¼š${template.plan.filter(p => p.isCore).length} ä¸ª\n\næ­£åœ¨åˆ†æç”¨æˆ·çš„çŸ¥è¯†åº“å†…å®¹...\nâœ“ æ£€ç´¢åˆ°ç›¸å…³æ–‡æ¡£ 15 ä»½\nâœ“ è¯†åˆ«å‡ºå…³é”®ä¿¡æ¯ "åŒå›¾é©±åŠ¨" "å¢é‡æ›´æ–°" "è”æƒ³å¼è®°å¿†"\n\nåˆ¶å®šæœ€ä¼˜ç”Ÿæˆé¡ºåºï¼š\n1. ä¼˜å…ˆç”Ÿæˆæ ¸å¿ƒç« èŠ‚ï¼ˆç ”ç©¶å†…å®¹ã€ç«‹é¢˜ä¾æ®ã€æ–¹æ¡ˆè®¾è®¡ï¼‰\n2. ç„¶åå¡«å……è¾…åŠ©ç« èŠ‚ï¼ˆé¢„æœŸæˆæœã€å·¥ä½œè®¡åˆ’ï¼‰\n3. æœ€åå®Œæˆå°é¢ä¿¡æ¯\n\nè®¡åˆ’å·²åˆ¶å®šå®Œæˆï¼Œå‡†å¤‡å±•ç¤º...`;

            typeText(thinkContent, thinking, 15, () => {
                const thinkingTitle = thinkingContainer.querySelector('.thinking-title span:last-child');
                thinkingTitle.textContent = 'Plan Agent æ€è€ƒè¿‡ç¨‹';
                
                // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
                updateAgentStatus('è®¡åˆ’åˆ¶å®šå®Œæˆï¼Œç­‰å¾…æ‚¨ç¡®è®¤...');

                setTimeout(() => {
                    // æŠ˜å æ€è€ƒè¿‡ç¨‹
                    thinkingContainer.classList.add('collapsed');
                    
                    // æ‰“å¼€ç”Ÿæˆè®¡åˆ’é¢æ¿
                    setTimeout(() => {
                        openPlanPanel(template);
                    }, 300);
                }, 500);
            });
        }

        // æ˜¾ç¤ºæ¨¡æ¿æ¨è
        function showTemplateRecommendations(container) {
            const html = `
                <div class="message-text">æ ¹æ®æ‚¨çš„éœ€æ±‚ï¼Œæˆ‘ä¸ºæ‚¨æ¨èä»¥ä¸‹ 3 ä¸ªç›¸å…³æ¨¡æ¿ï¼š</div>
                <div class="template-recommendations">
                    ${TEMPLATES.map((template, index) => `
                        <div class="template-card" id="template-${index}">
                            <div class="template-header">
                                <div class="template-title">
                                    <span>${index + 1}ï¸âƒ£</span>
                                    <span>${template.name}</span>
                                </div>
                                <div class="template-match">${template.match}% åŒ¹é…</div>
                            </div>
                            <div class="template-meta">
                                ğŸ“‘ ${template.sections} ä¸ªç« èŠ‚  ğŸ†” ${template.id.substring(0, 12)}...
                            </div>
                            <div class="template-actions">
                                <button class="template-btn template-btn-primary" onclick="useTemplate(${index})">
                                    âœ“ ä½¿ç”¨æ­¤æ¨¡æ¿
                                </button>
                                <button class="template-btn template-btn-secondary" onclick="toggleTemplateStructure(${index})">
                                    ğŸ‘ï¸ é¢„è§ˆç»“æ„
                                </button>
                            </div>
                            <div class="template-structure">
                                <div class="template-structure-title">â–¼ æ¨¡æ¿ç»“æ„é¢„è§ˆï¼š</div>
                                ${template.structure.map(line => `<div>${line}</div>`).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            // é€å­—æ˜¾ç¤ºæ¨èæ–‡æœ¬
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            container.appendChild(tempDiv);
            scrollToBottom();
        }

        // åˆ‡æ¢æ¨¡æ¿ç»“æ„æ˜¾ç¤º
        function toggleTemplateStructure(index) {
            const card = document.getElementById(`template-${index}`);
            card.classList.toggle('expanded');
        }

        // ä½¿ç”¨æ¨¡æ¿
        function useTemplate(index) {
            const template = TEMPLATES[index];
            
            // æ·»åŠ ç”¨æˆ·é€‰æ‹©æ¶ˆæ¯
            const chatMessages = document.getElementById('chatMessages');
            const userChoiceDiv = document.createElement('div');
            userChoiceDiv.className = 'message user';
            userChoiceDiv.innerHTML = `
                <div class="message-avatar">U</div>
                <div class="message-content">
                    <div class="message-text">é€‰æ‹©æ¨¡æ¿ï¼š${template.name}</div>
                </div>
            `;
            chatMessages.appendChild(userChoiceDiv);
            scrollToBottom();

            // åˆ‡æ¢åˆ° Plan Agent
            setTimeout(() => {
                switchToPlanAgent();
                
                // æ·»åŠ åˆ‡æ¢æç¤ºæ¶ˆæ¯
                addAgentSwitchMessage();
                
                // æ˜¾ç¤º Plan Agent æ€è€ƒè¿‡ç¨‹
                setTimeout(() => {
                    showPlanAgentThinkingAndPlan(template);
                }, 800);
            }, 500);
        }

        // æ‰“å¼€ç”Ÿæˆè®¡åˆ’é¢æ¿
        function openPlanPanel(template) {
            currentPlan = template; // ä¿å­˜å½“å‰è®¡åˆ’
            
            const panel = document.getElementById('generationPlanPanel');
            const planConfirmation = document.getElementById('planConfirmation');
            const planProgressText = document.getElementById('planProgressText');
            const planProgressFill = document.getElementById('planProgressFill');
            
            panel.classList.add('open');
            
            // æ˜¾ç¤ºç¡®è®¤æŒ‰é’®
            planConfirmation.classList.remove('hidden');
            
            // é‡ç½®è¿›åº¦
            planProgressText.textContent = 'ç­‰å¾…ç¡®è®¤...';
            planProgressFill.style.width = '0%';
            
            // ç”Ÿæˆè®¡åˆ’å†…å®¹
            const planContent = document.getElementById('planContent');
            planContent.innerHTML = template.plan.map((item, index) => `
                <div class="plan-item pending" id="plan-item-${index}">
                    <div class="plan-item-header">
                        <span class="plan-item-status">â³</span>
                        <span class="plan-item-title">${item.title}</span>
                        ${item.isCore ? '<span class="plan-item-badge badge-core">æ ¸å¿ƒ</span>' : ''}
                    </div>
                    <div class="plan-item-desc">${item.desc}</div>
                </div>
            `).join('');
            
            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            updateAgentStatus('è®¡åˆ’å·²åˆ¶å®šï¼Œè¯·ç¡®è®¤æ˜¯å¦å¼€å§‹ç”Ÿæˆ...');
            
            // æ·»åŠ ç­‰å¾…ç¡®è®¤æ¶ˆæ¯
            const chatMessages = document.getElementById('chatMessages');
            const planReadyDiv = document.createElement('div');
            planReadyDiv.className = 'message ai';
            planReadyDiv.innerHTML = `
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    <div class="message-text" style="background: #fef3c7; 
                                                      border-left: 3px solid #f59e0b; 
                                                      padding: 12px 16px; 
                                                      border-radius: 8px;
                                                      color: #92400e;">
                        â¸ï¸ <strong>ç­‰å¾…ç¡®è®¤</strong>
                    </div>
                    <div class="message-text" style="margin-top: 8px; font-size: 13px; color: var(--text-secondary);">
                        ğŸ“‹ å…± ${template.plan.length} ä¸ªç« èŠ‚ï¼Œé¢„è®¡ç”Ÿæˆæ—¶é—´ 12-15 åˆ†é’Ÿ<br>
                        ğŸ’¡ è¯·åœ¨å³ä¾§é¢æ¿æŸ¥çœ‹è¯¦ç»†è®¡åˆ’ï¼Œç¡®è®¤åå³å¯å¼€å§‹ç”Ÿæˆ<br>
                        âš ï¸ æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥è¾“å…¥æ–°çš„æŒ‡ä»¤æ¥ä¿®æ”¹è®¡åˆ’
                    </div>
                </div>
            `;
            chatMessages.appendChild(planReadyDiv);
            scrollToBottom();
        }

        // ç¡®è®¤è®¡åˆ’ï¼Œå¼€å§‹ç”Ÿæˆ
        function confirmPlan() {
            if (!currentPlan) return;
            
            // æ ‡è®°ä¸ºæ­£åœ¨ç”Ÿæˆ
            isGenerating = true;
            
            // éšè—ç¡®è®¤æŒ‰é’®
            document.getElementById('planConfirmation').classList.add('hidden');
            
            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            updateAgentStatus('å¼€å§‹æ‰§è¡Œç”Ÿæˆè®¡åˆ’...');
            
            // æ·»åŠ ç¡®è®¤æ¶ˆæ¯
            const chatMessages = document.getElementById('chatMessages');
            const confirmDiv = document.createElement('div');
            confirmDiv.className = 'message ai';
            confirmDiv.innerHTML = `
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    <div class="message-text" style="color: var(--success-color); font-weight: 500;">
                        ğŸš€ å·²ç¡®è®¤ï¼å¼€å§‹ç”Ÿæˆæ–‡æ¡£...
                    </div>
                    <div class="message-text" style="margin-top: 8px; font-size: 13px; color: var(--text-tertiary);">
                        ğŸ’¡ æç¤ºï¼šç”Ÿæˆè¿‡ç¨‹ä¸­æ‚¨ä»å¯ä»¥è¾“å…¥æŒ‡ä»¤è¿›è¡Œå¹²é¢„
                    </div>
                </div>
            `;
            chatMessages.appendChild(confirmDiv);
            scrollToBottom();
            
            // å¼€å§‹ç”Ÿæˆ
            setTimeout(() => {
                startGeneration(currentPlan.plan);
            }, 500);
        }

        // å–æ¶ˆè®¡åˆ’
        function cancelPlan() {
            // å…³é—­è®¡åˆ’é¢æ¿
            document.getElementById('generationPlanPanel').classList.remove('open');
            
            // åˆ‡æ¢å› Main Agent
            switchToMainAgent();
            
            // é‡ç½®çŠ¶æ€
            currentPlan = null;
            isGenerating = false;
            
            // æ·»åŠ å–æ¶ˆæ¶ˆæ¯
            const chatMessages = document.getElementById('chatMessages');
            const cancelDiv = document.createElement('div');
            cancelDiv.className = 'message ai';
            cancelDiv.innerHTML = `
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    <div class="message-text" style="color: var(--text-secondary);">
                        âŒ å·²å–æ¶ˆç”Ÿæˆè®¡åˆ’ã€‚å¦‚éœ€é‡æ–°å¼€å§‹ï¼Œè¯·å‘Šè¯‰æˆ‘æ‚¨çš„éœ€æ±‚ã€‚
                    </div>
                </div>
            `;
            chatMessages.appendChild(cancelDiv);
            scrollToBottom();
        }

        // å…³é—­è®¡åˆ’é¢æ¿
        function closePlanPanel() {
            document.getElementById('generationPlanPanel').classList.remove('open');
        }

        // å¼€å§‹ç”Ÿæˆæ–‡æ¡£
        function startGeneration(plan) {
            let currentIndex = 0;
            const totalItems = plan.length;
            
            function generateNext() {
                if (currentIndex >= totalItems) {
                    // å…¨éƒ¨å®Œæˆ
                    finishGeneration();
                    return;
                }
                
                const item = plan[currentIndex];
                const itemElement = document.getElementById(`plan-item-${currentIndex}`);
                
                // æ›´æ–°ä¸ºç”Ÿæˆä¸­çŠ¶æ€
                itemElement.className = 'plan-item generating';
                itemElement.querySelector('.plan-item-status').textContent = 'âš™ï¸';
                
                // æ›´æ–°è¿›åº¦
                const progress = Math.round(((currentIndex + 0.5) / totalItems) * 100);
                document.getElementById('planProgressFill').style.width = progress + '%';
                document.getElementById('planProgressText').textContent = `æ­£åœ¨ç”Ÿæˆï¼š${currentIndex + 1}/${totalItems} ç« èŠ‚`;
                
                // åœ¨å¯¹è¯åŒºæ˜¾ç¤ºç”Ÿæˆå†…å®¹
                showGeneratingSection(item);
                
                // æ¨¡æ‹Ÿç”Ÿæˆæ—¶é—´ï¼ˆ3-5ç§’ï¼ŒåŒ…å«æ€è€ƒæ—¶é—´ï¼‰
                const duration = 3000 + Math.random() * 2000;
                setTimeout(() => {
                    // å®Œæˆå½“å‰é¡¹
                    itemElement.className = 'plan-item completed';
                    itemElement.querySelector('.plan-item-status').textContent = 'âœ…';
                    
                    // æ·»åŠ ç« èŠ‚å®Œæˆ Brief æ‘˜è¦
                    addSectionCompleteBrief(item, currentIndex);
                    
                    currentIndex++;
                    setTimeout(generateNext, 500);
                }, duration);
            }
            
            generateNext();
        }

        // æ·»åŠ ç« èŠ‚å®Œæˆ Brief æ‘˜è¦
        function addSectionCompleteBrief(item, index) {
            const chatMessages = document.getElementById('chatMessages');
            const briefDiv = document.createElement('div');
            briefDiv.className = 'message ai';
            
            // æ ¹æ®ä¸åŒç« èŠ‚ç”Ÿæˆä¸åŒçš„æ‘˜è¦
            const briefContents = {
                0: 'é˜æ˜äº†åŒå›¾é©±åŠ¨è®°å¿†ç®¡ç†çš„ä¸‰ä¸ªæ ¸å¿ƒç ”ç©¶ç›®æ ‡ï¼šçŸ¥è¯†å›¾è°±ä¸å…³è”å›¾è°±çš„ååŒè®¾è®¡ã€å¢é‡æ›´æ–°æœºåˆ¶çš„å®ç°ã€ä»¥åŠè”æƒ³å¼æ£€ç´¢ç®—æ³•çš„ä¼˜åŒ–ã€‚',
                1: 'ç³»ç»Ÿé˜è¿°äº†äººå·¥æ™ºèƒ½è®°å¿†ç®¡ç†é¢†åŸŸçš„ç ”ç©¶èƒŒæ™¯ï¼Œåˆ†æäº†ä¼ ç»Ÿæ–¹æ³•çš„ä¸è¶³ï¼Œå¹¶è¯´æ˜äº†åŒå›¾ç»“æ„æ–¹æ¡ˆçš„å¿…è¦æ€§å’Œåˆ›æ–°ä»·å€¼ã€‚',
                2: 'è¯¦ç»†è®¾è®¡äº†æŠ€æœ¯å®ç°è·¯çº¿ï¼ŒåŒ…æ‹¬å›¾ç»“æ„ schema å®šä¹‰ã€CRUD æ“ä½œå®ç°ã€å¢é‡æ›´æ–°ç®—æ³•å’Œè”æƒ³æ£€ç´¢å¼•æ“çš„å…·ä½“æ–¹æ¡ˆã€‚',
                3: 'æ˜ç¡®äº†é¢„æœŸäº¤ä»˜æˆæœå’Œæœ¬ç ”ç©¶çš„ä¸‰å¤§åˆ›æ–°ç‚¹ï¼šåŒå›¾ååŒæ¶æ„ã€æ—¶é—´æˆ³ç‰ˆæœ¬æ§åˆ¶ã€ä»¥åŠåŸºäº PageRank çš„è”æƒ³æ£€ç´¢ã€‚',
                4: 'åˆ¶å®šäº†è¯¦ç»†çš„ 6 ä¸ªæœˆç ”ç©¶è®¡åˆ’å’Œé¢„ç®—æ–¹æ¡ˆï¼ŒåŒ…å«å›¾ç»“æ„è®¾è®¡ã€ç®—æ³•å®ç°å’Œå®éªŒéªŒè¯ä¸‰ä¸ªé˜¶æ®µã€‚',
                5: 'å®Œæˆäº†åŸºæœ¬ä¿¡æ¯å¡«å†™ï¼ŒåŒ…æ‹¬ç ”ç©¶é¢˜ç›®ã€ç ”ç©¶ç”Ÿä¿¡æ¯ã€å¯¼å¸ˆä¿¡æ¯å’Œæ‰€å±å­¦é™¢ç­‰å¿…è¦å†…å®¹ã€‚'
            };
            
            const briefText = briefContents[index] || `å®Œæˆäº†"${item.title}"çš„å†…å®¹ç¼–å†™ã€‚`;
            
            briefDiv.innerHTML = `
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    <div class="message-text" style="background: #f0fdf4; 
                                                      border-left: 3px solid #10b981; 
                                                      padding: 12px 16px; 
                                                      border-radius: 8px;">
                        <div style="font-weight: 600; color: #059669; margin-bottom: 8px;">
                            âœ… å®Œæˆï¼š${item.title}
                        </div>
                        <div style="font-size: 13px; color: #047857; line-height: 1.6;">
                            ${briefText}
                        </div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(briefDiv);
            scrollToBottom();
        }

        // åœ¨å¯¹è¯åŒºæ˜¾ç¤º Writer Agent çš„ ReAct æ€è€ƒå’Œç”Ÿæˆè¿‡ç¨‹
        function showGeneratingSection(item) {
            const chatMessages = document.getElementById('chatMessages');
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'message ai';
            sectionDiv.innerHTML = `
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    <div class="thinking-container">
                        <div class="thinking-header" onclick="toggleThinking(this)">
                            <div class="thinking-title">
                                <span class="thinking-icon">ğŸ¤”</span>
                                <span>Writer Agent æ€è€ƒä¸­...</span>
                            </div>
                            <span class="thinking-toggle">â–¼</span>
                        </div>
                        <div class="thinking-content">
                            <div id="writer-thinking-${Date.now()}"></div>
                        </div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(sectionDiv);
            scrollToBottom();

            // æ¨¡æ‹Ÿ Writer Agent çš„ ReAct æ€è€ƒè¿‡ç¨‹
            const thinkContent = sectionDiv.querySelector('[id^="writer-thinking-"]');
            const thinkingContainer = sectionDiv.querySelector('.thinking-container');

            // ReAct æ€è€ƒå†…å®¹
            const thinkingSteps = [
                `ğŸ“‹ æ”¶åˆ°ä»»åŠ¡ï¼šç¼–å†™"${item.title}"`,
                `\nğŸ¯ ä»»åŠ¡ç›®æ ‡ï¼š${item.desc}`,
                `\n\nğŸ“š Step 1 - ä¿¡æ¯æ”¶é›†ï¼š`,
                `\næ­£åœ¨ RAG æ£€ç´¢çŸ¥è¯†åº“...`,
                `\nâœ“ æ£€ç´¢åˆ° 5 æ¡ç›¸å…³æ–‡æ¡£`,
                `\nâœ“ æå–å…³é”®ä¿¡æ¯ç‚¹ 12 ä¸ª`,
                `\n\nğŸ¤” Step 2 - å†…å®¹åˆ¤æ–­ï¼š`,
                `\nåˆ†æå·²æœ‰ä¿¡æ¯çš„å®Œæ•´æ€§...`,
                `\nâ†’ èƒŒæ™¯ä¿¡æ¯ï¼šå……è¶³ âœ“`,
                `\nâ†’ æ ¸å¿ƒè®ºç‚¹ï¼šå……è¶³ âœ“`,
                item.isCore ? `\nâ†’ æŠ€æœ¯ç»†èŠ‚ï¼šéœ€è¦è¡¥å……ï¼Œå†æ¬¡æ£€ç´¢...` : `\nâ†’ è®ºæ®æ”¯æ’‘ï¼šå……è¶³ âœ“`,
                item.isCore ? `\n\nğŸ” Step 3 - äºŒæ¬¡æ£€ç´¢ï¼š\nå…³é”®è¯ï¼š["å¢é‡æ›´æ–°æœºåˆ¶", "æ€§èƒ½ä¼˜åŒ–"]\nâœ“ è¡¥å……ä¿¡æ¯å·²è·å–` : '',
                `\n\nâœ… ä¿¡æ¯åˆ¤æ–­å®Œæˆï¼šä¿¡æ¯å·²å……è¶³`,
                `\n\nâœï¸ Step ${item.isCore ? '4' : '3'} - è°ƒç”¨ Editor toolï¼š`,
                `\nå¼€å§‹å†™å…¥æ–‡æ¡£...`
            ].filter(Boolean).join('');

            // æµå¼è¾“å‡ºæ€è€ƒè¿‡ç¨‹
            typeText(thinkContent, thinkingSteps, 20, () => {
                // æ€è€ƒå®Œæˆ
                const thinkingTitle = thinkingContainer.querySelector('.thinking-title span:last-child');
                thinkingTitle.textContent = 'Writer Agent æ€è€ƒè¿‡ç¨‹';
                
                // æŠ˜å æ€è€ƒè¿‡ç¨‹
                setTimeout(() => {
                    thinkingContainer.classList.add('collapsed');
                    
                    // æ€è€ƒå®Œæˆåï¼Œæ‰æ˜¾ç¤º"æ­£åœ¨ç¼–å†™"çŠ¶æ€å¡ç‰‡
                    setTimeout(() => {
                        showWritingStatusCard(item);
                    }, 300);
                }, 500);
            });
        }

        // æ˜¾ç¤º"æ­£åœ¨ç¼–å†™"çŠ¶æ€å¡ç‰‡ï¼ˆåœ¨æ€è€ƒå®Œæˆåè°ƒç”¨ï¼‰
        function showWritingStatusCard(item) {
            const chatMessages = document.getElementById('chatMessages');
            const statusDiv = document.createElement('div');
            statusDiv.className = 'message ai';
            statusDiv.innerHTML = `
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    <div class="message-text status-card" 
                         style="background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); 
                                border-left: 3px solid var(--primary-color); 
                                padding: 12px 16px; 
                                border-radius: 8px;
                                cursor: pointer;
                                transition: all 0.2s;"
                         onmouseover="this.style.transform='translateX(4px)'; this.style.boxShadow='0 4px 12px rgba(139, 92, 246, 0.2)'"
                         onmouseout="this.style.transform=''; this.style.boxShadow=''"
                         onclick="focusDocumentPreview('${item.title}')">
                        <div style="font-weight: 600; color: var(--primary-color);">
                            âš™ï¸ æ­£åœ¨ç¼–å†™ï¼š${item.title}
                        </div>
                        <div style="margin-top: 4px; font-size: 13px; color: var(--text-secondary);">
                            ğŸ‘† ç‚¹å‡»å¯æŸ¥çœ‹æ–‡æ¡£åŒºå®æ—¶è¾“å‡º
                        </div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(statusDiv);
            scrollToBottom();
        }

        // èšç„¦åˆ°æ–‡æ¡£é¢„è§ˆåŒºï¼ˆç‚¹å‡»çŠ¶æ€å¡ç‰‡æ—¶è°ƒç”¨ï¼‰
        function focusDocumentPreview(chapterTitle) {
            const previewSidebar = document.getElementById('previewSidebar');
            const previewDocTitle = document.getElementById('previewDocTitle');
            
            // å¦‚æœé¢„è§ˆé¢æ¿æœªæ‰“å¼€ï¼Œæ‰“å¼€å®ƒ
            if (!previewSidebar.classList.contains('open')) {
                previewDocTitle.textContent = 'æ­£åœ¨ç”Ÿæˆï¼š' + chapterTitle;
                previewSidebar.classList.add('open');
                
                // æ·»åŠ ä¸€ä¸ªè§†è§‰åé¦ˆ
                const previewContent = document.getElementById('previewContent');
                previewContent.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 16px;">âš™ï¸</div>
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">æ­£åœ¨ç”Ÿæˆ</div>
                        <div style="font-size: 14px;">${chapterTitle}</div>
                        <div style="font-size: 13px; margin-top: 16px; color: var(--text-tertiary);">
                            æ–‡æ¡£å†…å®¹å°†åœ¨ç”Ÿæˆå®Œæˆåæ˜¾ç¤º
                        </div>
                    </div>
                `;
            } else {
                // å¦‚æœå·²ç»æ‰“å¼€ï¼Œæ·»åŠ ä¸€ä¸ªé—ªçƒæ•ˆæœæç¤ºç”¨æˆ·
                previewSidebar.style.boxShadow = '0 0 20px rgba(139, 92, 246, 0.5)';
                setTimeout(() => {
                    previewSidebar.style.boxShadow = '';
                }, 500);
            }
        }

        // å®Œæˆç”Ÿæˆ
        function finishGeneration() {
            // æ ‡è®°ç”Ÿæˆå®Œæˆ
            isGenerating = false;
            
            // æ›´æ–°è¿›åº¦ä¸º100%
            document.getElementById('planProgressFill').style.width = '100%';
            document.getElementById('planProgressText').textContent = 'âœ… å…¨éƒ¨å®Œæˆï¼';
            
            // åˆ‡æ¢å› Main Agent
            switchToMainAgent();
            
            // åœ¨å¯¹è¯åŒºæ˜¾ç¤ºå®Œæˆæ¶ˆæ¯
            const chatMessages = document.getElementById('chatMessages');
            const completeDiv = document.createElement('div');
            completeDiv.className = 'message ai';
            completeDiv.innerHTML = `
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    <div class="status-badge">âœ“ æ–‡æ¡£ç”Ÿæˆå®Œæˆï¼</div>
                    <div class="message-text" style="margin-top: 12px;">
                        ğŸ“„ <strong>åŒå›¾é©±åŠ¨çš„è”æƒ³å¼è®°å¿†å¢é‡æ›´æ–°ç®—æ³•ç ”ç©¶å¼€é¢˜æŠ¥å‘Š</strong>
                    </div>
                    <div class="message-text" style="margin-top: 12px; font-size: 13px;">
                        ğŸ“Š ç»Ÿè®¡ä¿¡æ¯ï¼š<br>
                        â€¢ æ€»å­—æ•°ï¼š8,523 å­—<br>
                        â€¢ ç« èŠ‚æ•°ï¼š6 ç« <br>
                        â€¢ ç”Ÿæˆæ—¶é•¿ï¼šçº¦ ${Math.floor((Date.now() % 100000) / 5000)} åˆ†é’Ÿ<br>
                    </div>
                    <div class="file-links" style="margin-top: 16px;">
                        <button class="file-link-button" onclick="alert('Demoæ¨¡å¼ï¼šä¸‹è½½åŠŸèƒ½')">ğŸ“¥ ä¸‹è½½ Markdown</button>
                        <button class="file-link-button" onclick="openPreview()">ğŸ‘ï¸ å®Œæ•´é¢„è§ˆ</button>
                    </div>
                </div>
            `;
            chatMessages.appendChild(completeDiv);
            scrollToBottom();
            
            // æ¸…ç©ºå½“å‰è®¡åˆ’
            currentPlan = null;
        }

        // ========== P1-6: æ‰§è¡Œé˜¶æ®µå¹²é¢„ ==========
        
        // å¤„ç†æ‰§è¡Œé˜¶æ®µçš„ç”¨æˆ·å¹²é¢„
        function handleGenerationInterruption(message) {
            const chatMessages = document.getElementById('chatMessages');
            
            // AI å“åº”ï¼šç†è§£ç”¨æˆ·æ„å›¾
            const responseDiv = document.createElement('div');
            responseDiv.className = 'message ai';
            responseDiv.innerHTML = `
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    <div class="thinking-container collapsed">
                        <div class="thinking-header" onclick="toggleThinking(this)">
                            <div class="thinking-title">
                                <span class="thinking-icon">ğŸ¤”</span>
                                <span>Plan Agent æ€è€ƒè¿‡ç¨‹</span>
                            </div>
                            <span class="thinking-toggle">â–¼</span>
                        </div>
                        <div class="thinking-content">
                            <div>æ”¶åˆ°æ‰§è¡ŒæœŸé—´çš„ç”¨æˆ·å¹²é¢„ï¼š"${message}"</div>
                            <div style="margin-top: 8px;">åˆ†ææ„å›¾...</div>
                            <div style="margin-top: 4px;">â†’ è¿™æ˜¯ä¸€ä¸ªä¿®æ”¹è¯·æ±‚</div>
                            <div style="margin-top: 4px;">â†’ éœ€è¦åŠ¨æ€æ’å…¥æ–°ä»»åŠ¡åˆ°è®¡åˆ’ä¸­</div>
                        </div>
                    </div>
                    <div class="message-text" style="margin-top: 12px;">
                        ğŸ“ æ”¶åˆ°æ‚¨çš„æŒ‡ä»¤ã€‚æˆ‘å°†åœ¨å½“å‰ä»»åŠ¡å®Œæˆåæ‰§è¡Œï¼š
                        <div style="background: #fef3c7; 
                                    border-left: 3px solid #f59e0b; 
                                    padding: 8px 12px; 
                                    border-radius: 6px;
                                    margin-top: 8px;
                                    font-size: 13px;">
                            "${message}"
                        </div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(responseDiv);
            scrollToBottom();
            
            // åŠ¨æ€æ’å…¥æ–°ä»»åŠ¡åˆ°è®¡åˆ’ä¸­
            insertNewTaskToPlan(message);
        }

        // åŠ¨æ€æ’å…¥æ–°ä»»åŠ¡åˆ°è®¡åˆ’
        function insertNewTaskToPlan(taskDescription) {
            const planContent = document.getElementById('planContent');
            const newTaskId = `plan-item-dynamic-${Date.now()}`;
            
            // åˆ›å»ºæ–°ä»»åŠ¡å…ƒç´ 
            const newTaskDiv = document.createElement('div');
            newTaskDiv.className = 'plan-item pending';
            newTaskDiv.id = newTaskId;
            newTaskDiv.style.animation = 'slideIn 0.3s ease-out';
            newTaskDiv.innerHTML = `
                <div class="plan-item-header">
                    <span class="plan-item-status">â³</span>
                    <span class="plan-item-title">ç”¨æˆ·å¹²é¢„ä»»åŠ¡</span>
                    <span class="plan-item-badge" style="background: #fed7aa; color: #92400e;">æ’å…¥</span>
                </div>
                <div class="plan-item-desc">${taskDescription}</div>
            `;
            
            // æ‰¾åˆ°ç¬¬ä¸€ä¸ª pending æˆ– generating ä»»åŠ¡ï¼Œæ’å…¥åˆ°å®ƒåé¢
            const pendingItems = planContent.querySelectorAll('.plan-item.pending, .plan-item.generating');
            if (pendingItems.length > 0) {
                pendingItems[0].insertAdjacentElement('afterend', newTaskDiv);
            } else {
                // å¦‚æœæ²¡æœ‰å¾…å¤„ç†ä»»åŠ¡ï¼Œæ·»åŠ åˆ°æœ€å
                planContent.appendChild(newTaskDiv);
            }
            
            // æ·»åŠ åŠ¨ç”»æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from {
                        opacity: 0;
                        transform: translateX(-20px);
                    }
                    to {
                        opacity: 1;
                        transform: translateX(0);
                    }
                }
            `;
            document.head.appendChild(style);
            
            // é«˜äº®æ–°æ’å…¥çš„ä»»åŠ¡
            setTimeout(() => {
                newTaskDiv.style.boxShadow = '0 0 15px rgba(251, 146, 60, 0.5)';
                setTimeout(() => {
                    newTaskDiv.style.boxShadow = '';
                }, 1000);
            }, 300);
        }

        // å¤„ç† Plan Agent é˜¶æ®µçš„é‡è§„åˆ’
        function handlePlanRegeneration(message) {
            const chatMessages = document.getElementById('chatMessages');
            
            // AI å“åº”
            const responseDiv = document.createElement('div');
            responseDiv.className = 'message ai';
            responseDiv.innerHTML = `
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    <div class="message-text">
                        ğŸ“ æ”¶åˆ°æ‚¨çš„æ–°éœ€æ±‚ï¼Œæ­£åœ¨é‡æ–°åˆ¶å®šè®¡åˆ’...
                    </div>
                </div>
            `;
            chatMessages.appendChild(responseDiv);
            scrollToBottom();
            
            // Demo: ç®€å•æç¤º
            setTimeout(() => {
                const demoDiv = document.createElement('div');
                demoDiv.className = 'message ai';
                demoDiv.innerHTML = `
                    <div class="message-avatar">AI</div>
                    <div class="message-content">
                        <div class="message-text" style="color: var(--text-tertiary); font-size: 13px;">
                            ğŸ’¡ Demo æ¨¡å¼ï¼šå®é™…ä½¿ç”¨æ—¶ä¼šåŸºäºæ–°éœ€æ±‚é‡æ–°ç”Ÿæˆè®¡åˆ’
                        </div>
                    </div>
                `;
                chatMessages.appendChild(demoDiv);
                scrollToBottom();
            }, 1000);
        }
    </script>
</body>
</html>

